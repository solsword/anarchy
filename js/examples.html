<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Peter Mawhorter" />
  <title>Anarchy Example Code</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="examples.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <!-- scripts -->
  <script type="text/javascript">
  // silly one-shot stub for require.js
  function define(reqs, module) { anarchy = module(reqs); }
  </script>
  <script src="js/anarchy.js"></script>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Anarchy Example Code</h1>
<p class="author">Peter Mawhorter</p>
</header>
<h1 id="anarchy-examples">Anarchy Examples</h1>
<p>This page contains worked examples of how to use the Anarchy library, using the JavaScript version of the library. Each example below shows the code used and then the result running live in the page.</p>
<h2 id="extra-examples">Extra examples:</h2>
<p>Here are a few more independent examples that compliment the ones on this page:</p>
<p><a href="fireworks.html">Fireworks</a> <a href="galaxies.html">Galaxies</a> <a href="card_deck.html">Cards</a> <a href="random_path.html">Random Paths</a></p>
<h2 id="basic-shuffling">Basic Shuffling</h2>
<p>Here’s a basic example showing how to use the shuffling interface.</p>
<p>You can enter a numerical seed value and hit shuffle to pick a specific shuffle, or just hit next to increment the seed and re-shuffle.</p>
<div id="shuffle_demo_controls">
<p><input id="shuffle_demo_seed" type="text" value="0"/> <input id="shuffle_demo_shuffle" type="button" value="shuffle"/> <input id="shuffle_demo_next" type="button" value="next"/></p>
</div>
<div id="shuffle_demo">

</div>
<p>Here is the core function that does the shuffle:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">// Function for setting the CSS grid-location properties of an item via</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">// anarchy.</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">function</span> <span class="at">do_shuffle</span>(seed) <span class="op">{</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="kw">in</span> items) <span class="op">{</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="kw">let</span> it <span class="op">=</span> items[i]<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="co">// Use anarchy to get a shuffled index for just this item:</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="kw">let</span> position <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(i<span class="op">,</span> <span class="va">items</span>.<span class="at">length</span><span class="op">,</span> seed)<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>    <span class="co">//let y = position % 4;</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="co">//let x = Math.floor(position / 4);</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>    <span class="kw">let</span> x <span class="op">=</span> position <span class="op">%</span> <span class="dv">7</span><span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="kw">let</span> y <span class="op">=</span> <span class="va">Math</span>.<span class="at">floor</span>(position <span class="op">/</span> <span class="dv">7</span>)<span class="op">;</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="va">it</span>.<span class="va">style</span>.<span class="at">gridColumnStart</span> <span class="op">=</span> <span class="st">&quot;&quot;</span> <span class="op">+</span> (x <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>    <span class="va">it</span>.<span class="va">style</span>.<span class="at">gridColumnEnd</span> <span class="op">=</span> <span class="st">&quot;&quot;</span> <span class="op">+</span> (x <span class="op">+</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>    <span class="va">it</span>.<span class="va">style</span>.<span class="at">gridRowStart</span> <span class="op">=</span> <span class="st">&quot;&quot;</span> <span class="op">+</span> (y <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>    <span class="va">it</span>.<span class="va">style</span>.<span class="at">gridRowEnd</span> <span class="op">=</span> <span class="st">&quot;&quot;</span> <span class="op">+</span> (y <span class="op">+</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>  <span class="op">}</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="op">}</span></span></code></pre></div>
<details>
<p><summary>Full code for the demo</summary></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">// Grab the div that we want to work with</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">let</span> div <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;shuffle_demo&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">// Create 26 divs each containing a single capital letter:</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">let</span> items <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="kw">let</span> letters <span class="op">=</span> <span class="st">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="kw">in</span> letters) <span class="op">{</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="kw">let</span> item <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)</span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="va">item</span>.<span class="at">innerText</span> <span class="op">=</span> letters[i]<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="va">items</span>.<span class="at">push</span>(item)<span class="op">;</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="op">}</span></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">// Add our divs to the grid in order:</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="kw">in</span> items) <span class="op">{</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>  <span class="va">div</span>.<span class="at">appendChild</span>(items[i])<span class="op">;</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="op">}</span></span>
<span id="cb2-17"><a href="#cb2-17"></a></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co">// Function for setting the CSS grid-location properties of an item via</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co">// anarchy.</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="kw">function</span> <span class="at">do_shuffle</span>(seed) <span class="op">{</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="kw">in</span> items) <span class="op">{</span></span>
<span id="cb2-22"><a href="#cb2-22"></a>    <span class="kw">let</span> it <span class="op">=</span> items[i]<span class="op">;</span></span>
<span id="cb2-23"><a href="#cb2-23"></a>    <span class="co">// Use anarchy to get a shuffled index for just this item:</span></span>
<span id="cb2-24"><a href="#cb2-24"></a>    <span class="kw">let</span> position <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(i<span class="op">,</span> <span class="va">items</span>.<span class="at">length</span><span class="op">,</span> seed)<span class="op">;</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>    <span class="co">//let y = position % 4;</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>    <span class="co">//let x = Math.floor(position / 4);</span></span>
<span id="cb2-27"><a href="#cb2-27"></a>    <span class="kw">let</span> x <span class="op">=</span> position <span class="op">%</span> <span class="dv">7</span><span class="op">;</span></span>
<span id="cb2-28"><a href="#cb2-28"></a>    <span class="kw">let</span> y <span class="op">=</span> <span class="va">Math</span>.<span class="at">floor</span>(position <span class="op">/</span> <span class="dv">7</span>)<span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>    <span class="va">it</span>.<span class="va">style</span>.<span class="at">gridColumnStart</span> <span class="op">=</span> <span class="st">&quot;&quot;</span> <span class="op">+</span> (x <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>    <span class="va">it</span>.<span class="va">style</span>.<span class="at">gridColumnEnd</span> <span class="op">=</span> <span class="st">&quot;&quot;</span> <span class="op">+</span> (x <span class="op">+</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-31"><a href="#cb2-31"></a>    <span class="va">it</span>.<span class="va">style</span>.<span class="at">gridRowStart</span> <span class="op">=</span> <span class="st">&quot;&quot;</span> <span class="op">+</span> (y <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb2-32"><a href="#cb2-32"></a>    <span class="va">it</span>.<span class="va">style</span>.<span class="at">gridRowEnd</span> <span class="op">=</span> <span class="st">&quot;&quot;</span> <span class="op">+</span> (y <span class="op">+</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-33"><a href="#cb2-33"></a>  <span class="op">}</span></span>
<span id="cb2-34"><a href="#cb2-34"></a><span class="op">}</span></span>
<span id="cb2-35"><a href="#cb2-35"></a></span>
<span id="cb2-36"><a href="#cb2-36"></a><span class="co">// Function for picking up seed from input</span></span>
<span id="cb2-37"><a href="#cb2-37"></a><span class="kw">function</span> <span class="at">get_seed</span>() <span class="op">{</span></span>
<span id="cb2-38"><a href="#cb2-38"></a>  <span class="kw">let</span> seed_input <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;shuffle_demo_seed&quot;</span>)<span class="op">;</span></span>
<span id="cb2-39"><a href="#cb2-39"></a>  <span class="kw">let</span> s <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">seed_input</span>.<span class="at">value</span>)<span class="op">;</span></span>
<span id="cb2-40"><a href="#cb2-40"></a>  <span class="cf">if</span> (s <span class="op">==</span> <span class="kw">undefined</span>) <span class="op">{</span></span>
<span id="cb2-41"><a href="#cb2-41"></a>    s <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-42"><a href="#cb2-42"></a>    <span class="va">seed_input</span>.<span class="at">value</span> <span class="op">=</span> s<span class="op">;</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>  <span class="op">}</span></span>
<span id="cb2-44"><a href="#cb2-44"></a>  <span class="cf">return</span> s<span class="op">;</span></span>
<span id="cb2-45"><a href="#cb2-45"></a><span class="op">}</span></span>
<span id="cb2-46"><a href="#cb2-46"></a></span>
<span id="cb2-47"><a href="#cb2-47"></a><span class="co">// Function for updating seed input</span></span>
<span id="cb2-48"><a href="#cb2-48"></a><span class="kw">function</span> <span class="at">set_seed</span>(x) <span class="op">{</span></span>
<span id="cb2-49"><a href="#cb2-49"></a>  <span class="kw">let</span> seed_input <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;shuffle_demo_seed&quot;</span>)<span class="op">;</span></span>
<span id="cb2-50"><a href="#cb2-50"></a>  <span class="va">seed_input</span>.<span class="at">value</span> <span class="op">=</span> x<span class="op">;</span></span>
<span id="cb2-51"><a href="#cb2-51"></a><span class="op">}</span></span>
<span id="cb2-52"><a href="#cb2-52"></a></span>
<span id="cb2-53"><a href="#cb2-53"></a><span class="co">// Do an initial shuffle</span></span>
<span id="cb2-54"><a href="#cb2-54"></a><span class="at">do_shuffle</span>(<span class="at">get_seed</span>())<span class="op">;</span></span>
<span id="cb2-55"><a href="#cb2-55"></a></span>
<span id="cb2-56"><a href="#cb2-56"></a><span class="co">// Set up shuffle button to use current seed:</span></span>
<span id="cb2-57"><a href="#cb2-57"></a><span class="kw">let</span> shuffle_button <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;shuffle_demo_shuffle&quot;</span>)</span>
<span id="cb2-58"><a href="#cb2-58"></a><span class="va">shuffle_button</span>.<span class="at">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span></span>
<span id="cb2-59"><a href="#cb2-59"></a>  <span class="at">do_shuffle</span>(<span class="at">get_seed</span>())<span class="op">;</span></span>
<span id="cb2-60"><a href="#cb2-60"></a><span class="op">}</span>)<span class="op">;</span></span>
<span id="cb2-61"><a href="#cb2-61"></a></span>
<span id="cb2-62"><a href="#cb2-62"></a><span class="co">// Set up next button to increment and shuffle:</span></span>
<span id="cb2-63"><a href="#cb2-63"></a><span class="kw">let</span> next_button <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;shuffle_demo_next&quot;</span>)</span>
<span id="cb2-64"><a href="#cb2-64"></a><span class="va">next_button</span>.<span class="at">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span></span>
<span id="cb2-65"><a href="#cb2-65"></a>  <span class="kw">let</span> seed <span class="op">=</span> <span class="at">get_seed</span>()<span class="op">;</span></span>
<span id="cb2-66"><a href="#cb2-66"></a>  seed <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-67"><a href="#cb2-67"></a>  <span class="at">set_seed</span>(seed)<span class="op">;</span></span>
<span id="cb2-68"><a href="#cb2-68"></a>  <span class="at">do_shuffle</span>(seed)<span class="op">;</span></span>
<span id="cb2-69"><a href="#cb2-69"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
</details>
<style>
#shuffle_demo {
  display: grid;
  width: 14em;
  height: 8em;
  width: calc(14em*0.75);
  height: calc(8em*0.75);
  margin: auto;
  grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
  grid-template-rows: 1fr 1fr 1fr 1fr;
  align-items: center;
  justify-items: center;
}

#shuffle_demo_controls {
  text-align: center;
}

</style>
<script type="text/javascript">
// Grab the div that we want to work with
let div = document.getElementById("shuffle_demo")

// Create 26 divs each containing a single capital letter:
let items = [];
let letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
for (let i in letters) {
  let item = document.createElement("div")
  item.innerText = letters[i];
  items.push(item);
}

// Add our divs to the grid in order:
for (let i in items) {
  div.appendChild(items[i]);
}

// Function for setting the CSS grid-location properties of an item via
// anarchy.
function do_shuffle(seed) {
  for (let i in items) {
    let it = items[i];
    // Use anarchy to get a shuffled index for just this item:
    let position = anarchy.cohort_shuffle(i, items.length, seed);
    //let y = position % 4;
    //let x = Math.floor(position / 4);
    let x = position % 7;
    let y = Math.floor(position / 7);
    it.style.gridColumnStart = "" + (x + 1);
    it.style.gridColumnEnd = "" + (x + 2);
    it.style.gridRowStart = "" + (y + 1);
    it.style.gridRowEnd = "" + (y + 2);
  }
}

// Function for picking up seed from input
function get_seed() {
  let seed_input = document.getElementById("shuffle_demo_seed");
  let s = parseInt(seed_input.value);
  if (s == undefined) {
    s = 0;
    seed_input.value = s;
  }
  return s;
}

// Function for updating seed input
function set_seed(x) {
  let seed_input = document.getElementById("shuffle_demo_seed");
  seed_input.value = x;
}

// Do an initial shuffle
do_shuffle(get_seed());

// Set up shuffle button to use current seed:
let shuffle_button = document.getElementById("shuffle_demo_shuffle")
shuffle_button.addEventListener("click", function () {
  do_shuffle(get_seed());
});

// Set up next button to increment and shuffle:
let next_button = document.getElementById("shuffle_demo_next")
next_button.addEventListener("click", function () {
  let seed = get_seed();
  seed += 1;
  set_seed(seed);
  do_shuffle(seed);
});

</script>
<h2 id="shuffling-vs.-independent-random-chance">Shuffling vs. Independent Random Chance</h2>
<p>This example shows the difference between using anarchy to shuffle a distribution vs. using standard independent sampling.</p>
<p>On the left, each tile has an independent 2% chance of being blue and 8% chance of being red. On the right, 2 out of the 100 tiles will always be blue, and an additional 8 will always be red. One or the other might be more accurate in different simulation contexts, and they also produce very different experiences in a game context.</p>
<div id="compare_demo_controls">
<p><input id="compare_demo_seed" type="text" value="0"/> <input id="compare_demo_update" type="button" value="update"/> <input id="compare_demo_next" type="button" value="next"/></p>
</div>
<canvas id="compare_demo" width="800" height="300">
</canvas>
<p>Here is the code for the two random number generators that generate sequences of 0’s, 1’s, and 2’s to determine color:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">// Creates RNG that spits out 0, 1, or 2 independently with 90%, 8%, and 2%</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">// probabilities.</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="kw">function</span> <span class="at">make_independent_rng</span>(seed) <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="kw">let</span> val <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>  <span class="cf">return</span> <span class="kw">function</span> () <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    val <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">prng</span>(val<span class="op">,</span> seed)<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="kw">let</span> u <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">udist</span>(val)<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="cf">if</span> (u <span class="op">&lt;=</span> <span class="fl">0.02</span>) <span class="op">{</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>      <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (u <span class="op">&lt;=</span> <span class="fl">0.1</span>) <span class="op">{</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>      <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>      <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>    <span class="op">}</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>  <span class="op">}</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="op">}</span></span>
<span id="cb3-17"><a href="#cb3-17"></a></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co">// Creates RNG that spits out 0, 1, or 2 based on shuffling 100 items, 90 of</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co">// which are 0&#39;s, 8 of which are 1&#39;s, and 2 of which are 2&#39;s. Repeats pattern</span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co">// exactly after the 100th item.</span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="kw">function</span> <span class="at">make_shuffle_rng</span>(seed) <span class="op">{</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>  <span class="kw">let</span> idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>  <span class="cf">return</span> <span class="kw">function</span> () <span class="op">{</span></span>
<span id="cb3-24"><a href="#cb3-24"></a>    <span class="kw">let</span> val <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(idx<span class="op">,</span> <span class="dv">100</span><span class="op">,</span> seed)<span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25"></a>    idx <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-26"><a href="#cb3-26"></a>    idx <span class="op">%=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb3-27"><a href="#cb3-27"></a>    <span class="cf">if</span> (val <span class="op">&lt;=</span> <span class="dv">1</span>) <span class="op">{</span></span>
<span id="cb3-28"><a href="#cb3-28"></a>      <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb3-29"><a href="#cb3-29"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (val <span class="op">&lt;=</span> <span class="dv">9</span>) <span class="op">{</span></span>
<span id="cb3-30"><a href="#cb3-30"></a>      <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-31"><a href="#cb3-31"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb3-32"><a href="#cb3-32"></a>      <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-33"><a href="#cb3-33"></a>    <span class="op">}</span></span>
<span id="cb3-34"><a href="#cb3-34"></a>  <span class="op">}</span></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="op">}</span></span></code></pre></div>
<details>
<p><summary>Full code for the demo</summary></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">function</span> <span class="at">enable_compare_demo</span>() <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="co">// Grab the div that we want to work with</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="kw">let</span> canvas <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;compare_demo&quot;</span>)<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="kw">let</span> ctx <span class="op">=</span> <span class="va">canvas</span>.<span class="at">getContext</span>(<span class="st">&quot;2d&quot;</span>)<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="kw">let</span> rect_size <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="kw">let</span> colors <span class="op">=</span> [<span class="st">&quot;white&quot;</span><span class="op">,</span> <span class="st">&quot;red&quot;</span><span class="op">,</span> <span class="st">&quot;blue&quot;</span>]<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10"></a></span>
<span id="cb4-11"><a href="#cb4-11"></a>  <span class="co">// Draws rectangle grid at the given x/y location using color values drawn</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>  <span class="co">// repeatedly from the given RNG function. That function must return a number</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>  <span class="co">// that&#39;s a valid index into the colors array.</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>  <span class="kw">function</span> <span class="at">draw_result</span>(where<span class="op">,</span> rng) <span class="op">{</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">100</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>      <span class="kw">let</span> r <span class="op">=</span> <span class="at">rng</span>()</span>
<span id="cb4-17"><a href="#cb4-17"></a>      <span class="kw">let</span> x <span class="op">=</span> i <span class="op">%</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>      <span class="kw">let</span> y <span class="op">=</span> <span class="va">Math</span>.<span class="at">floor</span>(i<span class="op">/</span><span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>      <span class="kw">let</span> cx <span class="op">=</span> where[<span class="dv">0</span>] <span class="op">+</span> rect_size<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> x <span class="op">*</span> rect_size<span class="op">;</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>      <span class="kw">let</span> cy <span class="op">=</span> where[<span class="dv">1</span>] <span class="op">+</span> rect_size<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> y <span class="op">*</span> rect_size<span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>      <span class="va">ctx</span>.<span class="at">fillStyle</span> <span class="op">=</span> colors[r]<span class="op">;</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>      <span class="va">ctx</span>.<span class="at">fillRect</span>(cx<span class="op">,</span> cy<span class="op">,</span> rect_size<span class="op">,</span> rect_size)<span class="op">;</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>      <span class="va">ctx</span>.<span class="at">strokeWidth</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>      <span class="va">ctx</span>.<span class="at">strokeStyle</span> <span class="op">=</span> <span class="st">&quot;black&quot;</span><span class="op">;</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>      <span class="va">ctx</span>.<span class="at">strokeRect</span>(cx<span class="op">,</span> cy<span class="op">,</span> rect_size<span class="op">,</span> rect_size)<span class="op">;</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>    <span class="op">}</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>  <span class="op">}</span></span>
<span id="cb4-28"><a href="#cb4-28"></a></span>
<span id="cb4-29"><a href="#cb4-29"></a>  <span class="co">// Creates RNG that spits out 0, 1, or 2 independently with 90%, 8%, and 2%</span></span>
<span id="cb4-30"><a href="#cb4-30"></a>  <span class="co">// probabilities.</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>  <span class="kw">function</span> <span class="at">make_independent_rng</span>(seed) <span class="op">{</span></span>
<span id="cb4-32"><a href="#cb4-32"></a>    <span class="kw">let</span> val <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>    <span class="cf">return</span> <span class="kw">function</span> () <span class="op">{</span></span>
<span id="cb4-34"><a href="#cb4-34"></a>      val <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">prng</span>(val<span class="op">,</span> seed)<span class="op">;</span></span>
<span id="cb4-35"><a href="#cb4-35"></a>      <span class="kw">let</span> u <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">udist</span>(val)<span class="op">;</span></span>
<span id="cb4-36"><a href="#cb4-36"></a>      <span class="cf">if</span> (u <span class="op">&lt;=</span> <span class="fl">0.02</span>) <span class="op">{</span></span>
<span id="cb4-37"><a href="#cb4-37"></a>        <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb4-38"><a href="#cb4-38"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (u <span class="op">&lt;=</span> <span class="fl">0.1</span>) <span class="op">{</span></span>
<span id="cb4-39"><a href="#cb4-39"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-40"><a href="#cb4-40"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb4-41"><a href="#cb4-41"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-42"><a href="#cb4-42"></a>      <span class="op">}</span></span>
<span id="cb4-43"><a href="#cb4-43"></a>    <span class="op">}</span></span>
<span id="cb4-44"><a href="#cb4-44"></a>  <span class="op">}</span></span>
<span id="cb4-45"><a href="#cb4-45"></a></span>
<span id="cb4-46"><a href="#cb4-46"></a>  <span class="co">// Creates RNG that spits out 0, 1, or 2 based on shuffling 100 items, 90 of</span></span>
<span id="cb4-47"><a href="#cb4-47"></a>  <span class="co">// which are 0&#39;s, 8 of which are 1&#39;s, and 2 of which are 2&#39;s. Repeats pattern</span></span>
<span id="cb4-48"><a href="#cb4-48"></a>  <span class="co">// exactly after the 100th item.</span></span>
<span id="cb4-49"><a href="#cb4-49"></a>  <span class="kw">function</span> <span class="at">make_shuffle_rng</span>(seed) <span class="op">{</span></span>
<span id="cb4-50"><a href="#cb4-50"></a>    <span class="kw">let</span> idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-51"><a href="#cb4-51"></a>    <span class="cf">return</span> <span class="kw">function</span> () <span class="op">{</span></span>
<span id="cb4-52"><a href="#cb4-52"></a>      <span class="kw">let</span> val <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(idx<span class="op">,</span> <span class="dv">100</span><span class="op">,</span> seed)<span class="op">;</span></span>
<span id="cb4-53"><a href="#cb4-53"></a>      idx <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-54"><a href="#cb4-54"></a>      idx <span class="op">%=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb4-55"><a href="#cb4-55"></a>      <span class="cf">if</span> (val <span class="op">&lt;=</span> <span class="dv">1</span>) <span class="op">{</span></span>
<span id="cb4-56"><a href="#cb4-56"></a>        <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb4-57"><a href="#cb4-57"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (val <span class="op">&lt;=</span> <span class="dv">9</span>) <span class="op">{</span></span>
<span id="cb4-58"><a href="#cb4-58"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-59"><a href="#cb4-59"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb4-60"><a href="#cb4-60"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-61"><a href="#cb4-61"></a>      <span class="op">}</span></span>
<span id="cb4-62"><a href="#cb4-62"></a>    <span class="op">}</span></span>
<span id="cb4-63"><a href="#cb4-63"></a>  <span class="op">}</span></span>
<span id="cb4-64"><a href="#cb4-64"></a></span>
<span id="cb4-65"><a href="#cb4-65"></a></span>
<span id="cb4-66"><a href="#cb4-66"></a>  <span class="co">// Shows results for the given seed by drawing four sampled results on the</span></span>
<span id="cb4-67"><a href="#cb4-67"></a>  <span class="co">// left and four shuffled results on the right.</span></span>
<span id="cb4-68"><a href="#cb4-68"></a>  <span class="kw">function</span> <span class="at">show_results</span>(seed) <span class="op">{</span></span>
<span id="cb4-69"><a href="#cb4-69"></a>    <span class="kw">let</span> base_seed <span class="op">=</span> seed <span class="op">*</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb4-70"><a href="#cb4-70"></a></span>
<span id="cb4-71"><a href="#cb4-71"></a>    <span class="kw">let</span> pad <span class="op">=</span> <span class="dv">100</span><span class="op">/</span><span class="dv">3</span><span class="op">;</span></span>
<span id="cb4-72"><a href="#cb4-72"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">4</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></span>
<span id="cb4-73"><a href="#cb4-73"></a>      <span class="kw">let</span> xo <span class="op">=</span> (i <span class="op">%</span> <span class="dv">2</span>) <span class="op">*</span> (<span class="dv">100</span> <span class="op">+</span> pad)<span class="op">;</span></span>
<span id="cb4-74"><a href="#cb4-74"></a>      <span class="kw">let</span> yo <span class="op">=</span> <span class="va">Math</span>.<span class="at">floor</span>(i <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> (<span class="dv">100</span> <span class="op">+</span> pad)<span class="op">;</span></span>
<span id="cb4-75"><a href="#cb4-75"></a>      <span class="kw">let</span> irng <span class="op">=</span> <span class="at">make_independent_rng</span>(base_seed <span class="op">+</span> i)<span class="op">;</span></span>
<span id="cb4-76"><a href="#cb4-76"></a>      <span class="kw">let</span> srng <span class="op">=</span> <span class="at">make_shuffle_rng</span>(base_seed <span class="op">+</span> i)<span class="op">;</span></span>
<span id="cb4-77"><a href="#cb4-77"></a></span>
<span id="cb4-78"><a href="#cb4-78"></a>      <span class="at">draw_result</span>([pad <span class="op">+</span> xo<span class="op">,</span> pad <span class="op">+</span> yo]<span class="op">,</span> irng)<span class="op">;</span></span>
<span id="cb4-79"><a href="#cb4-79"></a>      <span class="at">draw_result</span>([<span class="dv">200</span> <span class="op">+</span> <span class="dv">4</span><span class="op">*</span>pad <span class="op">+</span> xo<span class="op">,</span> pad <span class="op">+</span> yo]<span class="op">,</span> srng)<span class="op">;</span></span>
<span id="cb4-80"><a href="#cb4-80"></a>    <span class="op">}</span></span>
<span id="cb4-81"><a href="#cb4-81"></a></span>
<span id="cb4-82"><a href="#cb4-82"></a>    <span class="co">// add dividing line</span></span>
<span id="cb4-83"><a href="#cb4-83"></a>    <span class="va">ctx</span>.<span class="at">strokeWidth</span> <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb4-84"><a href="#cb4-84"></a>    <span class="va">ctx</span>.<span class="at">strokeStyle</span> <span class="op">=</span> <span class="st">&quot;black&quot;</span><span class="op">;</span></span>
<span id="cb4-85"><a href="#cb4-85"></a>    <span class="va">ctx</span>.<span class="at">beginPath</span>()<span class="op">;</span></span>
<span id="cb4-86"><a href="#cb4-86"></a>    <span class="va">ctx</span>.<span class="at">moveTo</span>(<span class="dv">300</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb4-87"><a href="#cb4-87"></a>    <span class="va">ctx</span>.<span class="at">lineTo</span>(<span class="dv">300</span><span class="op">,</span> <span class="dv">600</span>)<span class="op">;</span></span>
<span id="cb4-88"><a href="#cb4-88"></a>    <span class="va">ctx</span>.<span class="at">stroke</span>()<span class="op">;</span></span>
<span id="cb4-89"><a href="#cb4-89"></a>  <span class="op">}</span></span>
<span id="cb4-90"><a href="#cb4-90"></a></span>
<span id="cb4-91"><a href="#cb4-91"></a>  <span class="co">// Function for picking up seed from input</span></span>
<span id="cb4-92"><a href="#cb4-92"></a>  <span class="kw">function</span> <span class="at">get_seed</span>() <span class="op">{</span></span>
<span id="cb4-93"><a href="#cb4-93"></a>    <span class="kw">let</span> seed_input <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;compare_demo_seed&quot;</span>)<span class="op">;</span></span>
<span id="cb4-94"><a href="#cb4-94"></a>    <span class="kw">let</span> s <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">seed_input</span>.<span class="at">value</span>)<span class="op">;</span></span>
<span id="cb4-95"><a href="#cb4-95"></a>    <span class="cf">if</span> (s <span class="op">==</span> <span class="kw">undefined</span>) <span class="op">{</span></span>
<span id="cb4-96"><a href="#cb4-96"></a>      s <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-97"><a href="#cb4-97"></a>      <span class="va">seed_input</span>.<span class="at">value</span> <span class="op">=</span> s<span class="op">;</span></span>
<span id="cb4-98"><a href="#cb4-98"></a>    <span class="op">}</span></span>
<span id="cb4-99"><a href="#cb4-99"></a>    <span class="cf">return</span> s<span class="op">;</span></span>
<span id="cb4-100"><a href="#cb4-100"></a>  <span class="op">}</span></span>
<span id="cb4-101"><a href="#cb4-101"></a></span>
<span id="cb4-102"><a href="#cb4-102"></a>  <span class="co">// Show initial results:</span></span>
<span id="cb4-103"><a href="#cb4-103"></a>  <span class="at">show_results</span>(<span class="at">get_seed</span>())</span>
<span id="cb4-104"><a href="#cb4-104"></a></span>
<span id="cb4-105"><a href="#cb4-105"></a>  <span class="co">// Function for updating seed input</span></span>
<span id="cb4-106"><a href="#cb4-106"></a>  <span class="kw">function</span> <span class="at">set_seed</span>(x) <span class="op">{</span></span>
<span id="cb4-107"><a href="#cb4-107"></a>    <span class="kw">let</span> seed_input <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;compare_demo_seed&quot;</span>)<span class="op">;</span></span>
<span id="cb4-108"><a href="#cb4-108"></a>    <span class="va">seed_input</span>.<span class="at">value</span> <span class="op">=</span> x<span class="op">;</span></span>
<span id="cb4-109"><a href="#cb4-109"></a>  <span class="op">}</span></span>
<span id="cb4-110"><a href="#cb4-110"></a></span>
<span id="cb4-111"><a href="#cb4-111"></a>  <span class="co">// Set up shuffle button to use current seed:</span></span>
<span id="cb4-112"><a href="#cb4-112"></a>  <span class="kw">let</span> cmp_update_button <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;compare_demo_update&quot;</span>)</span>
<span id="cb4-113"><a href="#cb4-113"></a>  <span class="va">cmp_update_button</span>.<span class="at">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span></span>
<span id="cb4-114"><a href="#cb4-114"></a>    <span class="at">show_results</span>(<span class="at">get_seed</span>())<span class="op">;</span></span>
<span id="cb4-115"><a href="#cb4-115"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb4-116"><a href="#cb4-116"></a></span>
<span id="cb4-117"><a href="#cb4-117"></a>  <span class="co">// Set up next button to increment and shuffle:</span></span>
<span id="cb4-118"><a href="#cb4-118"></a>  <span class="kw">let</span> cmp_next_button <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;compare_demo_next&quot;</span>)</span>
<span id="cb4-119"><a href="#cb4-119"></a>  <span class="va">cmp_next_button</span>.<span class="at">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span></span>
<span id="cb4-120"><a href="#cb4-120"></a>    <span class="kw">let</span> seed <span class="op">=</span> <span class="at">get_seed</span>()<span class="op">;</span></span>
<span id="cb4-121"><a href="#cb4-121"></a>    seed <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-122"><a href="#cb4-122"></a>    <span class="at">set_seed</span>(seed)<span class="op">;</span></span>
<span id="cb4-123"><a href="#cb4-123"></a>    <span class="at">show_results</span>(seed)<span class="op">;</span></span>
<span id="cb4-124"><a href="#cb4-124"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb4-125"><a href="#cb4-125"></a><span class="op">}</span></span>
<span id="cb4-126"><a href="#cb4-126"></a></span>
<span id="cb4-127"><a href="#cb4-127"></a><span class="co">// Run all this stuff:</span></span>
<span id="cb4-128"><a href="#cb4-128"></a><span class="at">enable_compare_demo</span>()<span class="op">;</span></span></code></pre></div>
</details>
<script>

function enable_compare_demo() {
  // Grab the div that we want to work with
  let canvas = document.getElementById("compare_demo");

  let ctx = canvas.getContext("2d");

  let rect_size = 10;

  let colors = ["white", "red", "blue"];

  // Draws rectangle grid at the given x/y location using color values drawn
  // repeatedly from the given RNG function. That function must return a number
  // that's a valid index into the colors array.
  function draw_result(where, rng) {
    for (let i = 0; i < 100; ++i) {
      let r = rng()
      let x = i % 10;
      let y = Math.floor(i/10);
      let cx = where[0] + rect_size/2 + x * rect_size;
      let cy = where[1] + rect_size/2 + y * rect_size;
      ctx.fillStyle = colors[r];
      ctx.fillRect(cx, cy, rect_size, rect_size);
      ctx.strokeWidth = 0.5;
      ctx.strokeStyle = "black";
      ctx.strokeRect(cx, cy, rect_size, rect_size);
    }
  }

  // Creates RNG that spits out 0, 1, or 2 independently with 90%, 8%, and 2%
  // probabilities.
  function make_independent_rng(seed) {
    let val = 0;
    return function () {
      val = anarchy.prng(val, seed);
      let u = anarchy.udist(val);
      if (u <= 0.02) {
        return 2;
      } else if (u <= 0.1) {
        return 1;
      } else {
        return 0;
      }
    }
  }

  // Creates RNG that spits out 0, 1, or 2 based on shuffling 100 items, 90 of
  // which are 0's, 8 of which are 1's, and 2 of which are 2's. Repeats pattern
  // exactly after the 100th item.
  function make_shuffle_rng(seed) {
    let idx = 0;
    return function () {
      let val = anarchy.cohort_shuffle(idx, 100, seed);
      idx += 1;
      idx %= 100;
      if (val <= 1) {
        return 2;
      } else if (val <= 9) {
        return 1;
      } else {
        return 0;
      }
    }
  }


  // Shows results for the given seed by drawing four sampled results on the
  // left and four shuffled results on the right.
  function show_results(seed) {
    let base_seed = seed * 4;

    let pad = 100/3;
    for (let i = 0; i < 4; ++i) {
      let xo = (i % 2) * (100 + pad);
      let yo = Math.floor(i / 2) * (100 + pad);
      let irng = make_independent_rng(base_seed + i);
      let srng = make_shuffle_rng(base_seed + i);

      draw_result([pad + xo, pad + yo], irng);
      draw_result([200 + 4*pad + xo, pad + yo], srng);
    }

    // add dividing line
    ctx.strokeWidth = 2;
    ctx.strokeStyle = "black";
    ctx.beginPath();
    ctx.moveTo(300, 0);
    ctx.lineTo(300, 600);
    ctx.stroke();
  }

  // Function for picking up seed from input
  function get_seed() {
    let seed_input = document.getElementById("compare_demo_seed");
    let s = parseInt(seed_input.value);
    if (s == undefined) {
      s = 0;
      seed_input.value = s;
    }
    return s;
  }

  // Show initial results:
  show_results(get_seed())

  // Function for updating seed input
  function set_seed(x) {
    let seed_input = document.getElementById("compare_demo_seed");
    seed_input.value = x;
  }

  // Set up shuffle button to use current seed:
  let cmp_update_button = document.getElementById("compare_demo_update")
  cmp_update_button.addEventListener("click", function () {
    show_results(get_seed());
  });

  // Set up next button to increment and shuffle:
  let cmp_next_button = document.getElementById("compare_demo_next")
  cmp_next_button.addEventListener("click", function () {
    let seed = get_seed();
    seed += 1;
    set_seed(seed);
    show_results(seed);
  });
}

// Run all this stuff:
enable_compare_demo();
</script>
<h2 id="scramble-an-enumerable-space">Scramble an Enumerable Space</h2>
<p>In some cases it’s easy to write an algorithm that generates a vast (but known) number of interesting artifacts, but the algorithm generates them in an ordered way so that locally they look quite similar. A standard augmentation is to just pick a random number from the potential space and use that to determine which item to generate, but those independent random numbers can in theory lead to repeats, and in practice this modification means that the algorithm which generates interesting artifacts in a more interesting order is no longer also an algorithm that will exhaustively enumerate the underlying space. Using <code>anarchy</code>’s shuffling mechanisms, we can incrementally pick numbers within a large possibility space (well, up to <span class="math inline">2<sup>64</sup></span> at least; that limitation is something to work on).</p>
<p>Here’s an example of a very simple enumerable space: We draw a line and then branch it into two, recursively in three layers to draw a tree. When the line splits, we make four binary decisions: we use either PI/6 or PI/4 for the angle of each new branch, and either 0.6 or 0.7 for the scale of each branches relative to the original line. Given four binary decisions for each subtree, with 3 layers we have 7 subtrees that aren’t terminal and so we require 28 bits to make all of the decisions, so there are <span class="math inline">2<sup>28</sup></span> trees in the space.</p>
<p>Here’s a canvas showing the first four items in the space. Note that we can see an obvious progression between the adjacent trees, which would be noticeable to a player: the first tree uses the smaller size and angle for both branches, the next tree uses a larger size for the left branch, then the next tree has a larger right branch, and the last tree has the larger size for both branches.</p>
<canvas width="650" height="300" id="enumeration_demo">
</canvas>
<p>Here’s the code that draws the trees:</p>
<details>
<p><summary>Tree Enumeration Code</summary></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">// Draws a line between the given pair of coordinates on the given canvas</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">function</span> <span class="at">draw_line</span>(canvas<span class="op">,</span> fr<span class="op">,</span> to) <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  ctx <span class="op">=</span> <span class="va">canvas</span>.<span class="at">getContext</span>(<span class="st">&quot;2d&quot;</span>)<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="va">ctx</span>.<span class="at">beginPath</span>()<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="va">ctx</span>.<span class="at">moveTo</span>(fr[<span class="dv">0</span>]<span class="op">,</span> fr[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="va">ctx</span>.<span class="at">lineTo</span>(to[<span class="dv">0</span>]<span class="op">,</span> to[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>  <span class="va">ctx</span>.<span class="at">stroke</span>()<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="op">}</span></span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">// Draws a tree on a canvas recursively</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="kw">function</span> <span class="at">draw_tree</span>(canvas<span class="op">,</span> root<span class="op">,</span> size<span class="op">,</span> seed<span class="op">,</span> which_branch<span class="op">,</span> angle) <span class="op">{</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>  <span class="co">// Define any unspecified arguments</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="cf">if</span> (which_branch <span class="op">==</span> <span class="kw">undefined</span>) <span class="op">{</span> which_branch <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>  <span class="cf">if</span> (size <span class="op">==</span> <span class="kw">undefined</span>) <span class="op">{</span> size <span class="op">=</span> <span class="dv">100</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>  <span class="cf">if</span> (angle <span class="op">==</span> <span class="kw">undefined</span>) <span class="op">{</span> angle <span class="op">=</span> <span class="dv">3</span><span class="op">*</span><span class="va">Math</span>.<span class="at">PI</span><span class="op">/</span><span class="dv">2</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>  <span class="cf">if</span> (root <span class="op">==</span> <span class="kw">undefined</span>) <span class="op">{</span> root <span class="op">=</span> [<span class="dv">250</span><span class="op">,</span> <span class="dv">250</span>]<span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-17"><a href="#cb5-17"></a></span>
<span id="cb5-18"><a href="#cb5-18"></a>  <span class="kw">let</span> end <span class="op">=</span> [</span>
<span id="cb5-19"><a href="#cb5-19"></a>    size <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(angle) <span class="op">+</span> root[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>    size <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(angle) <span class="op">+</span> root[<span class="dv">1</span>]</span>
<span id="cb5-21"><a href="#cb5-21"></a>  ]<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>  <span class="at">draw_line</span>(canvas<span class="op">,</span> root<span class="op">,</span> end)<span class="op">;</span></span>
<span id="cb5-23"><a href="#cb5-23"></a></span>
<span id="cb5-24"><a href="#cb5-24"></a>  <span class="kw">let</span> my_seed <span class="op">=</span> seed <span class="op">&gt;&gt;&gt;</span> (which_branch <span class="op">*</span> <span class="dv">4</span>)<span class="op">;</span></span>
<span id="cb5-25"><a href="#cb5-25"></a></span>
<span id="cb5-26"><a href="#cb5-26"></a>  <span class="co">// Three decisions:</span></span>
<span id="cb5-27"><a href="#cb5-27"></a>  <span class="kw">let</span> d1 <span class="op">=</span> my_seed <span class="op">&amp;</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>  <span class="kw">let</span> d2 <span class="op">=</span> my_seed <span class="op">&amp;</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb5-29"><a href="#cb5-29"></a>  <span class="kw">let</span> d3 <span class="op">=</span> my_seed <span class="op">&amp;</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb5-30"><a href="#cb5-30"></a>  <span class="kw">let</span> d4 <span class="op">=</span> my_seed <span class="op">&amp;</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb5-31"><a href="#cb5-31"></a></span>
<span id="cb5-32"><a href="#cb5-32"></a>  <span class="kw">let</span> sub_size_a <span class="op">=</span> <span class="fl">0.6</span><span class="op">;</span></span>
<span id="cb5-33"><a href="#cb5-33"></a>  <span class="cf">if</span> (d1) <span class="op">{</span> sub_size_a <span class="op">=</span> <span class="fl">0.7</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-34"><a href="#cb5-34"></a>  <span class="kw">let</span> sub_size_b <span class="op">=</span> <span class="fl">0.6</span><span class="op">;</span></span>
<span id="cb5-35"><a href="#cb5-35"></a>  <span class="cf">if</span> (d2) <span class="op">{</span> sub_size_b <span class="op">=</span> <span class="fl">0.7</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-36"><a href="#cb5-36"></a>  <span class="kw">let</span> angle_a <span class="op">=</span> <span class="va">Math</span>.<span class="at">PI</span><span class="op">/</span><span class="dv">6</span><span class="op">;</span></span>
<span id="cb5-37"><a href="#cb5-37"></a>  <span class="cf">if</span> (d3) <span class="op">{</span> angle_a <span class="op">=</span> <span class="va">Math</span>.<span class="at">PI</span><span class="op">/</span><span class="dv">4</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-38"><a href="#cb5-38"></a>  <span class="kw">let</span> angle_b <span class="op">=</span> <span class="va">Math</span>.<span class="at">PI</span><span class="op">/</span><span class="dv">6</span><span class="op">;</span></span>
<span id="cb5-39"><a href="#cb5-39"></a>  <span class="cf">if</span> (d4) <span class="op">{</span> angle_b <span class="op">=</span> <span class="va">Math</span>.<span class="at">PI</span><span class="op">/</span><span class="dv">4</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-40"><a href="#cb5-40"></a></span>
<span id="cb5-41"><a href="#cb5-41"></a>  <span class="co">// Recursive calls if we&#39;re in the body of the tree:</span></span>
<span id="cb5-42"><a href="#cb5-42"></a>  <span class="cf">if</span> (which_branch <span class="op">&lt;</span> <span class="dv">16</span>) <span class="op">{</span></span>
<span id="cb5-43"><a href="#cb5-43"></a>    <span class="at">draw_tree</span>(</span>
<span id="cb5-44"><a href="#cb5-44"></a>      canvas<span class="op">,</span></span>
<span id="cb5-45"><a href="#cb5-45"></a>      end<span class="op">,</span></span>
<span id="cb5-46"><a href="#cb5-46"></a>      sub_size_a <span class="op">*</span> size<span class="op">,</span></span>
<span id="cb5-47"><a href="#cb5-47"></a>      seed<span class="op">,</span></span>
<span id="cb5-48"><a href="#cb5-48"></a>      (which_branch <span class="op">*</span> <span class="dv">2</span>) <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb5-49"><a href="#cb5-49"></a>      angle <span class="op">+</span> angle_a</span>
<span id="cb5-50"><a href="#cb5-50"></a>    )<span class="op">;</span></span>
<span id="cb5-51"><a href="#cb5-51"></a>    <span class="at">draw_tree</span>(</span>
<span id="cb5-52"><a href="#cb5-52"></a>      canvas<span class="op">,</span></span>
<span id="cb5-53"><a href="#cb5-53"></a>      end<span class="op">,</span></span>
<span id="cb5-54"><a href="#cb5-54"></a>      sub_size_b <span class="op">*</span> size<span class="op">,</span></span>
<span id="cb5-55"><a href="#cb5-55"></a>      seed<span class="op">,</span></span>
<span id="cb5-56"><a href="#cb5-56"></a>      (which_branch <span class="op">*</span> <span class="dv">2</span>) <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb5-57"><a href="#cb5-57"></a>      angle <span class="op">-</span> angle_b</span>
<span id="cb5-58"><a href="#cb5-58"></a>    )<span class="op">;</span></span>
<span id="cb5-59"><a href="#cb5-59"></a>  <span class="op">}</span></span>
<span id="cb5-60"><a href="#cb5-60"></a><span class="op">}</span></span>
<span id="cb5-61"><a href="#cb5-61"></a></span>
<span id="cb5-62"><a href="#cb5-62"></a><span class="co">// Grab the canvas and draw the trees corresponding to the first four seeds:</span></span>
<span id="cb5-63"><a href="#cb5-63"></a><span class="kw">let</span> canvas <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;enumeration_demo&quot;</span>)<span class="op">;</span></span>
<span id="cb5-64"><a href="#cb5-64"></a><span class="at">draw_tree</span>(canvas<span class="op">,</span> [<span class="dv">100</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-65"><a href="#cb5-65"></a><span class="at">draw_tree</span>(canvas<span class="op">,</span> [<span class="dv">250</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-66"><a href="#cb5-66"></a><span class="at">draw_tree</span>(canvas<span class="op">,</span> [<span class="dv">400</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb5-67"><a href="#cb5-67"></a><span class="at">draw_tree</span>(canvas<span class="op">,</span> [<span class="dv">550</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span></span></code></pre></div>
</details>
<script type="text/javascript">
// Draws a line between the given pair of coordinates on the given canvas
function draw_line(canvas, fr, to) {
  ctx = canvas.getContext("2d");
  ctx.beginPath();
  ctx.moveTo(fr[0], fr[1]);
  ctx.lineTo(to[0], to[1]);
  ctx.stroke();
}

// Draws a tree on a canvas recursively
function draw_tree(canvas, root, size, seed, which_branch, angle) {
  // Define any unspecified arguments
  if (which_branch == undefined) { which_branch = 0; }
  if (size == undefined) { size = 100; }
  if (angle == undefined) { angle = 3*Math.PI/2; }
  if (root == undefined) { root = [250, 250]; }

  let end = [
    size * Math.cos(angle) + root[0],
    size * Math.sin(angle) + root[1]
  ];
  draw_line(canvas, root, end);

  let my_seed = seed >>> (which_branch * 4);

  // Three decisions:
  let d1 = my_seed & 1;
  let d2 = my_seed & 2;
  let d3 = my_seed & 4;
  let d4 = my_seed & 8;

  let sub_size_a = 0.6;
  if (d1) { sub_size_a = 0.7; }
  let sub_size_b = 0.6;
  if (d2) { sub_size_b = 0.7; }
  let angle_a = Math.PI/6;
  if (d3) { angle_a = Math.PI/4; }
  let angle_b = Math.PI/6;
  if (d4) { angle_b = Math.PI/4; }

  // Recursive calls if we're in the body of the tree:
  if (which_branch < 16) {
    draw_tree(
      canvas,
      end,
      sub_size_a * size,
      seed,
      (which_branch * 2) + 1,
      angle + angle_a
    );
    draw_tree(
      canvas,
      end,
      sub_size_b * size,
      seed,
      (which_branch * 2) + 1,
      angle - angle_b
    );
  }
}

// Grab the canvas and draw the trees corresponding to the first four seeds:
let canvas = document.getElementById("enumeration_demo");
draw_tree(canvas, [100, 200], 50, 0);
draw_tree(canvas, [250, 200], 50, 1);
draw_tree(canvas, [400, 200], 50, 2);
draw_tree(canvas, [550, 200], 50, 3);
</script>
<p>This canvas shows four trees which were seeded using shuffled numbers. In this setup, the trees are still being enumerated, and the enumeration will not repeat until it completes, but we’re moving through the seeds in a pseudo-random order, and there’s no longer an obvious relationship between adjacent trees.</p>
<canvas width="650" height="300" id="shuffled_enumeration_demo">
</canvas>
<p>Here’s the code for the shuffled trees:</p>
<details>
<p><summary>Code Using Shuffling</summary></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">// Grab the canvas and draw the trees corresponding to the first four seeds,</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">// but shuffled:</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">let</span> s_canvas <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;shuffled_enumeration_demo&quot;</span>)<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="kw">let</span> N <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">28</span><span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="kw">let</span> seed <span class="op">=</span> <span class="dv">129837123</span><span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="at">draw_tree</span>(s_canvas<span class="op">,</span> [<span class="dv">100</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(<span class="dv">0</span><span class="op">,</span> N<span class="op">,</span> seed))<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="at">draw_tree</span>(s_canvas<span class="op">,</span> [<span class="dv">250</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(<span class="dv">1</span><span class="op">,</span> N<span class="op">,</span> seed))<span class="op">;</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="at">draw_tree</span>(s_canvas<span class="op">,</span> [<span class="dv">400</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(<span class="dv">2</span><span class="op">,</span> N<span class="op">,</span> seed))<span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="at">draw_tree</span>(s_canvas<span class="op">,</span> [<span class="dv">550</span><span class="op">,</span> <span class="dv">200</span>]<span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(<span class="dv">3</span><span class="op">,</span> N<span class="op">,</span> seed))<span class="op">;</span></span></code></pre></div>
</details>
<script type="text/javascript">
// Grab the canvas and draw the trees corresponding to the first four seeds,
// but shuffled:
let s_canvas = document.getElementById("shuffled_enumeration_demo");
let N = 1 << 28;
let seed = 129837123;
draw_tree(s_canvas, [100, 200], 50, anarchy.cohort_shuffle(0, N, seed));
draw_tree(s_canvas, [250, 200], 50, anarchy.cohort_shuffle(1, N, seed));
draw_tree(s_canvas, [400, 200], 50, anarchy.cohort_shuffle(2, N, seed));
draw_tree(s_canvas, [550, 200], 50, anarchy.cohort_shuffle(3, N, seed));
</script>
<p>Note that the <span class="math inline">2<sup>64</sup></span> limit on the space being scrambled here (and it’s only <span class="math inline">2<sup>32</sup></span> in JavaScript!). That’s a huge issue for this particular application, and it would be nice if someone found a clever way around this.</p>
<p>The canvas below shows unshuffled trees on the top row and shuffled ones on the bottom. You can click the buttons to scroll through the space of trees (the end of the space is at 268435452).</p>
<p><input type="button" value="<" id="enumeration_demo_previous"> <input type="text" value="0" id="enumeration_demo_here"> <input type="button" value=">" id="enumeration_demo_next"></p>
<canvas width="650" height="600" id="interactive_enumeration_demo">
</canvas>
<script type="text/javascript">
let pr = document.getElementById("enumeration_demo_previous");
let hr = document.getElementById("enumeration_demo_here");
let nx = document.getElementById("enumeration_demo_next");

function redraw(n) {
  if (n == undefined) { n = 0; }
  let canvas = document.getElementById("interactive_enumeration_demo");
  canvas.getContext("2d").clearRect(0, 0, 650, 600);
  let N = 1 << 28;
  let seed = 129837123;
  draw_tree(canvas, [100, 200], 50, n + 0);
  draw_tree(canvas, [250, 200], 50, n + 1);
  draw_tree(canvas, [400, 200], 50, n + 2);
  draw_tree(canvas, [550, 200], 50, n + 3);

  draw_tree(canvas, [100, 500], 50, anarchy.cohort_shuffle(n + 0, N, seed));
  draw_tree(canvas, [250, 500], 50, anarchy.cohort_shuffle(n + 1, N, seed));
  draw_tree(canvas, [400, 500], 50, anarchy.cohort_shuffle(n + 2, N, seed));
  draw_tree(canvas, [550, 500], 50, anarchy.cohort_shuffle(n + 3, N, seed));
}

let here = 0;

function cycle_prev() {
  here = parseInt(hr.value);
  here -= 1;
  if (here <= 0) {
    here = 0;
    pr.disabled = true;
  } else {
    pr.disabled = false;
  }
  nx.disabled = false;
  hr.value = here;
  redraw(here);
}

function cycle_next() {
  here = parseInt(hr.value);
  here += 1;
  if (here >= (1 << 28) - 4) {
    here = (1 << 28) - 4;
    nx.disabled = true;
  } else {
    nx.disabled = false;
  }
  pr.disabled = false;
  hr.value = here;
  redraw(here);
}

pr.addEventListener("click", cycle_prev);
nx.addEventListener("click", cycle_next);
hr.addEventListener("blur", function () { redraw(parseInt(hr.value)) });

redraw(0);
hr.value = 0;
pr.disabled = true;
</script>
<h3 id="another-enumerable-space">Another Enumerable Space</h3>
<p>Here’s another example of an enumerable space: a grammar-based space of generated poems. The code for the generator uses bits from a seed to make each decision it comes across, and we’re cheating because our grammar is incredibly simple (it has no recursion nor even any nodes that will ever be expanded more than once; it also only needs 30 bits of entropy, including wasted half bits).</p>
<p>The cheating is nice because it allows me to easily figure out which bits will be used to make which decision, and therefore be able to filter the grammar to produce only expansions where a particular key expands in a particular way (I’ve done the math to figure out how to fix the “plums” result in this case). That math would be… more difficult, in a non-trivial grammar.</p>
<p>The code for the grammar including the filtering is below. To find only poems matching a filter, you use the <code>expand_limited_seed</code> function and give it a seed that’s smaller than <code>lim_gr_full</code>, which is the number of possible seed bit configurations excluding the choice about plums. You also tell it which value you want the plums key to expand to, and it then gives you back a seed that’s in the full range (up to <code>gr_full</code>) with the desired bits for the plums decision baked in.</p>
<details>
<p><summary>Grammar Code</summary></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">let</span> grammar <span class="op">=</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="st">&quot;root&quot;</span><span class="op">:</span> <span class="st">&quot;{title}&lt;br/&gt;&lt;br/&gt;{graf1}&lt;br/&gt;{graf2}&lt;br/&gt;{graf3}&quot;</span><span class="op">,</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="st">&quot;title&quot;</span><span class="op">:</span> [ <span class="st">&quot;This Is Just To Say&quot;</span><span class="op">,</span> <span class="st">&quot;Re: Your Inquiry&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="st">&quot;graf1&quot;</span><span class="op">:</span> [</span>
<span id="cb7-5"><a href="#cb7-5"></a>    <span class="st">&quot;I have {eaten}&lt;br/&gt;the {plums}&lt;br/&gt;that were in&lt;br/&gt;the {container}&lt;br/&gt;&quot;</span><span class="op">,</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>    <span class="st">&quot;Although you&lt;br/&gt;did not mention&lt;br/&gt;the {plums}&lt;br/&gt;that you had {collected}&lt;br/&gt;&quot;</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>  ]<span class="op">,</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>  <span class="st">&quot;graf2&quot;</span><span class="op">:</span> [</span>
<span id="cb7-9"><a href="#cb7-9"></a>    <span class="st">&quot;and which&lt;br/&gt;you were probably&lt;br/&gt;{saving}&lt;br/&gt;for {breakfast}&lt;br/&gt;&quot;</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>  ]<span class="op">,</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>  <span class="st">&quot;graf3&quot;</span><span class="op">:</span> [</span>
<span id="cb7-12"><a href="#cb7-12"></a>    <span class="st">&quot;{forgive} me&lt;br/&gt;they were {delicious}&lt;br/&gt;so {sweet}&lt;br/&gt; and so {cold}&quot;</span><span class="op">,</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>    <span class="st">&quot;considering your&lt;br/&gt;{outrageous} behavior&lt;br/&gt;I cannot&lt;br/&gt;{regret} my actions&quot;</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>  ]<span class="op">,</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="st">&quot;eaten&quot;</span><span class="op">:</span> [ <span class="st">&quot;eaten&quot;</span><span class="op">,</span> <span class="st">&quot;consumed&quot;</span><span class="op">,</span> <span class="st">&quot;eliminated&quot;</span><span class="op">,</span> <span class="st">&quot;transformed&quot;</span><span class="op">,</span> <span class="st">&quot;crushed&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>  <span class="st">&quot;plums&quot;</span><span class="op">:</span> [ <span class="st">&quot;plums&quot;</span><span class="op">,</span> <span class="st">&quot;peaches&quot;</span><span class="op">,</span> <span class="st">&quot;apples&quot;</span><span class="op">,</span> <span class="st">&quot;larvae&quot;</span> ]<span class="op">,</span> <span class="co">// 6th and 7th bits?</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>  <span class="st">&quot;container&quot;</span><span class="op">:</span> [ <span class="st">&quot;icebox&quot;</span><span class="op">,</span> <span class="st">&quot;refridgerator&quot;</span><span class="op">,</span> <span class="st">&quot;paper bag&quot;</span><span class="op">,</span> <span class="st">&quot;kitchen&quot;</span><span class="op">,</span> <span class="st">&quot;underworld&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-18"><a href="#cb7-18"></a>  <span class="st">&quot;saving&quot;</span><span class="op">:</span> [ <span class="st">&quot;saving&quot;</span><span class="op">,</span> <span class="st">&quot;hoarding&quot;</span><span class="op">,</span> <span class="st">&quot;eyeing&quot;</span><span class="op">,</span> <span class="st">&quot;considering&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>  <span class="st">&quot;breakfast&quot;</span><span class="op">:</span> [ <span class="st">&quot;breakfast&quot;</span><span class="op">,</span> <span class="st">&quot;lunch&quot;</span><span class="op">,</span> <span class="st">&quot;dinner&quot;</span><span class="op">,</span> <span class="st">&quot;the ritual&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>  <span class="st">&quot;forgive&quot;</span><span class="op">:</span> [ <span class="st">&quot;forgive&quot;</span><span class="op">,</span> <span class="st">&quot;pardon&quot;</span><span class="op">,</span> <span class="st">&quot;excuse&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-21"><a href="#cb7-21"></a>  <span class="st">&quot;delicious&quot;</span><span class="op">:</span> [ <span class="st">&quot;delicious&quot;</span><span class="op">,</span> <span class="st">&quot;delectible&quot;</span><span class="op">,</span> <span class="st">&quot;tempting&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>  <span class="st">&quot;sweet&quot;</span><span class="op">:</span> [ <span class="st">&quot;sweet&quot;</span><span class="op">,</span> <span class="st">&quot;juicy&quot;</span><span class="op">,</span> <span class="st">&quot;purple&quot;</span><span class="op">,</span> <span class="st">&quot;soft&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>  <span class="st">&quot;cold&quot;</span><span class="op">:</span> [ <span class="st">&quot;cold&quot;</span><span class="op">,</span> <span class="st">&quot;round&quot;</span><span class="op">,</span> <span class="st">&quot;smooth&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-24"><a href="#cb7-24"></a>  <span class="st">&quot;collected&quot;</span><span class="op">:</span> [ <span class="st">&quot;acquired&quot;</span><span class="op">,</span> <span class="st">&quot;collected&quot;</span><span class="op">,</span> <span class="st">&quot;obtained&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-25"><a href="#cb7-25"></a>  <span class="st">&quot;outrageous&quot;</span><span class="op">:</span> [ <span class="st">&quot;outrageous&quot;</span><span class="op">,</span> <span class="st">&quot;past&quot;</span><span class="op">,</span> <span class="st">&quot;current&quot;</span><span class="op">,</span> <span class="st">&quot;uncouth&quot;</span><span class="op">,</span> <span class="st">&quot;magnanimous&quot;</span>]<span class="op">,</span></span>
<span id="cb7-26"><a href="#cb7-26"></a>  <span class="st">&quot;regret&quot;</span><span class="op">:</span> [ <span class="st">&quot;regret&quot;</span><span class="op">,</span> <span class="st">&quot;excuse&quot;</span><span class="op">,</span> <span class="st">&quot;repudiate&quot;</span> ]<span class="op">,</span></span>
<span id="cb7-27"><a href="#cb7-27"></a><span class="op">}</span></span>
<span id="cb7-28"><a href="#cb7-28"></a></span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="kw">let</span> gr_combinations <span class="op">=</span> <span class="dv">1</span><span class="op">*</span><span class="dv">2</span><span class="op">*</span><span class="dv">2</span><span class="op">*</span><span class="dv">1</span><span class="op">*</span><span class="dv">2</span><span class="op">*</span><span class="dv">5</span><span class="op">*</span><span class="dv">4</span><span class="op">*</span><span class="dv">5</span><span class="op">*</span><span class="dv">4</span><span class="op">*</span><span class="dv">4</span><span class="op">*</span><span class="dv">3</span><span class="op">*</span><span class="dv">3</span><span class="op">*</span><span class="dv">4</span><span class="op">*</span><span class="dv">3</span><span class="op">*</span><span class="dv">3</span><span class="op">*</span><span class="dv">5</span><span class="op">*</span><span class="dv">3</span><span class="op">;</span> <span class="co">// ~ 19 bits</span></span>
<span id="cb7-30"><a href="#cb7-30"></a><span class="kw">let</span> gr_bits <span class="op">=</span> <span class="dv">0</span><span class="op">+</span><span class="dv">1</span><span class="op">+</span><span class="dv">1</span><span class="op">+</span><span class="dv">0</span><span class="op">+</span><span class="dv">1</span><span class="op">+</span><span class="dv">3</span><span class="op">+</span><span class="dv">2</span><span class="op">+</span><span class="dv">3</span><span class="op">+</span><span class="dv">2</span><span class="op">+</span><span class="dv">2</span><span class="op">+</span><span class="dv">2</span><span class="op">+</span><span class="dv">2</span><span class="op">+</span><span class="dv">2</span><span class="op">+</span><span class="dv">2</span><span class="op">+</span><span class="dv">2</span><span class="op">+</span><span class="dv">3</span><span class="op">+</span><span class="dv">2</span><span class="op">;</span> <span class="co">// bits actually used</span></span>
<span id="cb7-31"><a href="#cb7-31"></a><span class="kw">let</span> gr_full <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> gr_bits<span class="op">;</span> <span class="co">// full # of bits used</span></span>
<span id="cb7-32"><a href="#cb7-32"></a><span class="kw">let</span> lim_gr_bits <span class="op">=</span> gr_bits <span class="op">-</span> <span class="dv">2</span><span class="op">;</span> <span class="co">// minus the plums choice</span></span>
<span id="cb7-33"><a href="#cb7-33"></a><span class="kw">let</span> lim_gr_full <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> lim_gr_bits<span class="op">;</span> <span class="co">// full # of bits used while limited</span></span>
<span id="cb7-34"><a href="#cb7-34"></a></span>
<span id="cb7-35"><a href="#cb7-35"></a><span class="co">// Takes a seed in the range [0, lim_gr_full), which is the right number of</span></span>
<span id="cb7-36"><a href="#cb7-36"></a><span class="co">// bits to specify every decision except the 2-bit decision for the grammar key</span></span>
<span id="cb7-37"><a href="#cb7-37"></a><span class="co">// &quot;plums&quot;, and expands it into the range [0, gr_full) so that it includes the</span></span>
<span id="cb7-38"><a href="#cb7-38"></a><span class="co">// bits necessary to specify the given value for the &quot;plums&quot; key. This is</span></span>
<span id="cb7-39"><a href="#cb7-39"></a><span class="co">// complicated by the fact that the &quot;plums&quot; decision happens in a different</span></span>
<span id="cb7-40"><a href="#cb7-40"></a><span class="co">// place depending on the decision for the expansion of graf1.</span></span>
<span id="cb7-41"><a href="#cb7-41"></a><span class="kw">function</span> <span class="at">expand_limited_seed</span>(ls<span class="op">,</span> plums_value) <span class="op">{</span></span>
<span id="cb7-42"><a href="#cb7-42"></a>  <span class="kw">let</span> dbits<span class="op">;</span></span>
<span id="cb7-43"><a href="#cb7-43"></a>  <span class="cf">if</span> (plums_value <span class="op">==</span> <span class="st">&quot;plums&quot;</span>) <span class="op">{</span></span>
<span id="cb7-44"><a href="#cb7-44"></a>    dbits <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-45"><a href="#cb7-45"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (plums_value <span class="op">==</span> <span class="st">&quot;peaches&quot;</span>) <span class="op">{</span></span>
<span id="cb7-46"><a href="#cb7-46"></a>    dbits <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-47"><a href="#cb7-47"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (plums_value <span class="op">==</span> <span class="st">&quot;apples&quot;</span>) <span class="op">{</span></span>
<span id="cb7-48"><a href="#cb7-48"></a>    dbits <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb7-49"><a href="#cb7-49"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (plums_value <span class="op">==</span> <span class="st">&quot;larvae&quot;</span>) <span class="op">{</span></span>
<span id="cb7-50"><a href="#cb7-50"></a>    dbits <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb7-51"><a href="#cb7-51"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb7-52"><a href="#cb7-52"></a>    <span class="va">console</span>.<span class="at">warn</span>(<span class="st">&quot;Invalid plums_value: &#39;&quot;</span> <span class="op">+</span> plums_value <span class="op">+</span> <span class="st">&quot;&#39;&quot;</span>)<span class="op">;</span></span>
<span id="cb7-53"><a href="#cb7-53"></a>    dbits <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-54"><a href="#cb7-54"></a>  <span class="op">}</span></span>
<span id="cb7-55"><a href="#cb7-55"></a>  <span class="cf">if</span> (ls <span class="op">&amp;</span> (<span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">1</span>)) <span class="op">{</span> <span class="co">// second bit is the graf1 decision</span></span>
<span id="cb7-56"><a href="#cb7-56"></a>    <span class="co">// In this case the plums decision is the 3rd and 4th bits</span></span>
<span id="cb7-57"><a href="#cb7-57"></a>    <span class="kw">let</span> before <span class="op">=</span> ls <span class="op">&amp;</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb7-58"><a href="#cb7-58"></a>    <span class="kw">let</span> after <span class="op">=</span> ls <span class="op">&amp;</span> ((<span class="op">~</span><span class="dv">3</span>) <span class="op">&gt;&gt;&gt;</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb7-59"><a href="#cb7-59"></a>    <span class="kw">let</span> result <span class="op">=</span> before <span class="op">|</span> (dbits <span class="op">&lt;&lt;</span> <span class="dv">2</span>) <span class="op">|</span> (after <span class="op">&lt;&lt;</span> <span class="dv">2</span>)</span>
<span id="cb7-60"><a href="#cb7-60"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb7-61"><a href="#cb7-61"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb7-62"><a href="#cb7-62"></a>    <span class="co">// In this case the plums decision is the 6th and 7th bits, because the</span></span>
<span id="cb7-63"><a href="#cb7-63"></a>    <span class="co">// eaten decision needs 3 bits and comes before the plums decision.</span></span>
<span id="cb7-64"><a href="#cb7-64"></a>    <span class="kw">let</span> mask <span class="op">=</span> ((<span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">5</span>) <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb7-65"><a href="#cb7-65"></a>    <span class="kw">let</span> before <span class="op">=</span> ls <span class="op">&amp;</span> mask<span class="op">;</span></span>
<span id="cb7-66"><a href="#cb7-66"></a>    <span class="kw">let</span> after <span class="op">=</span> ls <span class="op">&amp;</span> ((<span class="op">~</span>mask) <span class="op">&gt;&gt;&gt;</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb7-67"><a href="#cb7-67"></a>    <span class="kw">let</span> result <span class="op">=</span> before <span class="op">|</span> (dbits <span class="op">&lt;&lt;</span> <span class="dv">5</span>) <span class="op">|</span> (after <span class="op">&lt;&lt;</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb7-68"><a href="#cb7-68"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb7-69"><a href="#cb7-69"></a>  <span class="op">}</span></span>
<span id="cb7-70"><a href="#cb7-70"></a><span class="op">}</span></span>
<span id="cb7-71"><a href="#cb7-71"></a></span>
<span id="cb7-72"><a href="#cb7-72"></a><span class="co">// Generates a poem according to a particular seed</span></span>
<span id="cb7-73"><a href="#cb7-73"></a><span class="kw">function</span> <span class="at">generate_poem</span>(grammar<span class="op">,</span> seed) <span class="op">{</span></span>
<span id="cb7-74"><a href="#cb7-74"></a>  <span class="co">// start at the root (which is not a list; just a string)</span></span>
<span id="cb7-75"><a href="#cb7-75"></a>  <span class="kw">let</span> sofar <span class="op">=</span> grammar[<span class="st">&quot;root&quot;</span>]<span class="op">;</span></span>
<span id="cb7-76"><a href="#cb7-76"></a>  <span class="kw">let</span> bits_used <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// track bits used to generate a warning if we need to</span></span>
<span id="cb7-77"><a href="#cb7-77"></a></span>
<span id="cb7-78"><a href="#cb7-78"></a>  <span class="co">// loop until there aren&#39;t any expansions</span></span>
<span id="cb7-79"><a href="#cb7-79"></a>  <span class="cf">while</span> (<span class="va">sofar</span>.<span class="at">indexOf</span>(<span class="st">&quot;{&quot;</span>) <span class="op">&gt;=</span> <span class="dv">0</span>) <span class="op">{</span></span>
<span id="cb7-80"><a href="#cb7-80"></a></span>
<span id="cb7-81"><a href="#cb7-81"></a>    <span class="co">// Look for the first expansion (denoted by curly braces) and figure out</span></span>
<span id="cb7-82"><a href="#cb7-82"></a>    <span class="co">// the before, after, and key:</span></span>
<span id="cb7-83"><a href="#cb7-83"></a>    <span class="kw">let</span> start <span class="op">=</span> <span class="va">sofar</span>.<span class="at">indexOf</span>(<span class="st">&quot;{&quot;</span>)<span class="op">;</span></span>
<span id="cb7-84"><a href="#cb7-84"></a>    <span class="kw">let</span> end <span class="op">=</span> <span class="va">sofar</span>.<span class="at">indexOf</span>(<span class="st">&quot;}&quot;</span>)<span class="op">;</span></span>
<span id="cb7-85"><a href="#cb7-85"></a>    <span class="kw">let</span> before <span class="op">=</span> <span class="va">sofar</span>.<span class="at">substr</span>(<span class="dv">0</span><span class="op">,</span> start)<span class="op">;</span></span>
<span id="cb7-86"><a href="#cb7-86"></a>    <span class="kw">let</span> after <span class="op">=</span> <span class="va">sofar</span>.<span class="at">substr</span>(end<span class="op">+</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb7-87"><a href="#cb7-87"></a>    <span class="kw">let</span> key <span class="op">=</span> <span class="va">sofar</span>.<span class="at">substr</span>(start<span class="op">+</span><span class="dv">1</span><span class="op">,</span> end <span class="op">-</span> start <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb7-88"><a href="#cb7-88"></a></span>
<span id="cb7-89"><a href="#cb7-89"></a>    <span class="cf">if</span> (<span class="va">grammar</span>.<span class="at">hasOwnProperty</span>(key)) <span class="op">{</span></span>
<span id="cb7-90"><a href="#cb7-90"></a>      <span class="co">// See what our options are and pick one, using up some bits of the seed.</span></span>
<span id="cb7-91"><a href="#cb7-91"></a>      <span class="kw">let</span> options <span class="op">=</span> grammar[key]<span class="op">;</span></span>
<span id="cb7-92"><a href="#cb7-92"></a>      <span class="kw">let</span> bits <span class="op">=</span> <span class="va">Math</span>.<span class="at">ceil</span>(<span class="va">Math</span>.<span class="at">log2</span>(<span class="va">options</span>.<span class="at">length</span>))<span class="op">;</span></span>
<span id="cb7-93"><a href="#cb7-93"></a>      <span class="kw">let</span> sel <span class="op">=</span> seed <span class="op">%</span> <span class="va">options</span>.<span class="at">length</span><span class="op">;</span></span>
<span id="cb7-94"><a href="#cb7-94"></a>      <span class="kw">let</span> selected <span class="op">=</span> options[sel]<span class="op">;</span></span>
<span id="cb7-95"><a href="#cb7-95"></a>      seed <span class="op">=</span> seed <span class="op">&gt;&gt;</span> bits<span class="op">;</span> <span class="co">// throw away used-up bits (wastes extra half bits)</span></span>
<span id="cb7-96"><a href="#cb7-96"></a>      bits_used <span class="op">+=</span> bits<span class="op">;</span></span>
<span id="cb7-97"><a href="#cb7-97"></a>      sofar <span class="op">=</span> before <span class="op">+</span> selected <span class="op">+</span> after<span class="op">;</span> <span class="co">// Reassemble a new working result</span></span>
<span id="cb7-98"><a href="#cb7-98"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb7-99"><a href="#cb7-99"></a>      <span class="co">// For missing keys, use the key as the value and issue a warning</span></span>
<span id="cb7-100"><a href="#cb7-100"></a>      sofar <span class="op">=</span> before <span class="op">+</span> key <span class="op">+</span> after<span class="op">;</span></span>
<span id="cb7-101"><a href="#cb7-101"></a>      <span class="va">console</span>.<span class="at">warn</span>(<span class="st">&quot;Missing grammar key: &#39;&quot;</span> <span class="op">+</span> key <span class="op">+</span> <span class="st">&quot;&#39;&quot;</span>)<span class="op">;</span></span>
<span id="cb7-102"><a href="#cb7-102"></a>    <span class="op">}</span></span>
<span id="cb7-103"><a href="#cb7-103"></a>    <span class="co">// Double-check that we haven&#39;t used too many bits</span></span>
<span id="cb7-104"><a href="#cb7-104"></a>    <span class="cf">if</span> (bits_used <span class="op">&gt;</span> <span class="dv">32</span>) <span class="op">{</span></span>
<span id="cb7-105"><a href="#cb7-105"></a>      <span class="va">console</span>.<span class="at">warn</span>(<span class="st">&quot;Used more than 32 bits: &quot;</span> <span class="op">+</span> bits_used)<span class="op">;</span></span>
<span id="cb7-106"><a href="#cb7-106"></a>    <span class="op">}</span></span>
<span id="cb7-107"><a href="#cb7-107"></a>  <span class="op">}</span></span>
<span id="cb7-108"><a href="#cb7-108"></a>  <span class="cf">return</span> sofar<span class="op">;</span></span>
<span id="cb7-109"><a href="#cb7-109"></a><span class="op">}</span></span></code></pre></div>
</details>
<p>In this code block, you can see the code for managing the UI elements and actually calling the generator. We use <code>anarchy</code>’s shuffling capabilities for the bottom row, so that subsequent poems are quite distinct, in contrast with the top row even when filtering is involved.</p>
<details>
<p><summary>UI and Anarchy Code</summary></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">// Get handles for each of our interface elements:</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">let</span> p_pr <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;poetry_demo_previous&quot;</span>)<span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">let</span> p_hr <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;poetry_demo_here&quot;</span>)<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="kw">let</span> p_nx <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;poetry_demo_next&quot;</span>)<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw">let</span> p_fl <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;poetry_demo_filter&quot;</span>)<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">let</span> p_sd <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;poetry_demo_seed&quot;</span>)<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="kw">let</span> p_sp <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;poetry_demo_seed_prev&quot;</span>)<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="kw">let</span> p_sn <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;poetry_demo_seed_next&quot;</span>)<span class="op">;</span></span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="kw">let</span> p_bucket <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;poetry_demo&quot;</span>)<span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11"></a></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="co">// This function does the heavy lifting: it looks at interface elements to</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="co">// determine the seed and where we are in the space, and overwrites nonsensical</span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="co">// values, then it calls generate_poem to create the required poems, puts them</span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="co">// in divs, labels them with their seeds, and uses them to replace the contents</span></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="co">// of the demo div.</span></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="kw">function</span> <span class="at">display_poems</span>() <span class="op">{</span></span>
<span id="cb8-18"><a href="#cb8-18"></a>  <span class="co">// Grab parameters (seed and position) from the UI and overwrite bad values:</span></span>
<span id="cb8-19"><a href="#cb8-19"></a>  <span class="kw">let</span> p_seed <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">p_sd</span>.<span class="at">value</span>) <span class="op">&gt;&gt;&gt;</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-20"><a href="#cb8-20"></a>  <span class="cf">if</span> (p_seed <span class="op">==</span> <span class="kw">undefined</span> <span class="op">||</span> <span class="at">isNaN</span>(p_seed)) <span class="op">{</span></span>
<span id="cb8-21"><a href="#cb8-21"></a>    p_seed <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>    <span class="va">p_sd</span>.<span class="at">value</span> <span class="op">=</span> p_seed<span class="op">;</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>  <span class="op">}</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>  <span class="kw">let</span> first <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">p_hr</span>.<span class="at">value</span>)<span class="op">;</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>  <span class="cf">if</span> (first <span class="op">==</span> <span class="kw">undefined</span> <span class="op">||</span> first <span class="op">&lt;=</span> <span class="dv">0</span>) <span class="op">{</span></span>
<span id="cb8-26"><a href="#cb8-26"></a>    first <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-27"><a href="#cb8-27"></a>    <span class="va">p_pr</span>.<span class="at">disabled</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb8-28"><a href="#cb8-28"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-29"><a href="#cb8-29"></a>    <span class="va">p_pr</span>.<span class="at">disabled</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb8-30"><a href="#cb8-30"></a>  <span class="op">}</span></span>
<span id="cb8-31"><a href="#cb8-31"></a>  <span class="cf">if</span> (first <span class="op">&gt;=</span> gr_combinations <span class="op">-</span> <span class="dv">4</span>) <span class="op">{</span></span>
<span id="cb8-32"><a href="#cb8-32"></a>    first <span class="op">=</span> gr_combinations <span class="op">-</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb8-33"><a href="#cb8-33"></a>    <span class="va">p_nx</span>.<span class="at">disabled</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb8-34"><a href="#cb8-34"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-35"><a href="#cb8-35"></a>    <span class="va">p_nx</span>.<span class="at">disabled</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb8-36"><a href="#cb8-36"></a>  <span class="op">}</span></span>
<span id="cb8-37"><a href="#cb8-37"></a>  <span class="va">p_hr</span>.<span class="at">value</span> <span class="op">=</span> first<span class="op">;</span></span>
<span id="cb8-38"><a href="#cb8-38"></a></span>
<span id="cb8-39"><a href="#cb8-39"></a>  <span class="co">// Figure out seeds for our non-shuffled poems:</span></span>
<span id="cb8-40"><a href="#cb8-40"></a>  <span class="kw">let</span> s1<span class="op">,</span> s2<span class="op">,</span> s3<span class="op">,</span> s4<span class="op">;</span></span>
<span id="cb8-41"><a href="#cb8-41"></a>  <span class="cf">if</span> (<span class="va">p_fl</span>.<span class="at">value</span> <span class="op">==</span> <span class="st">&quot;none&quot;</span>) <span class="op">{</span></span>
<span id="cb8-42"><a href="#cb8-42"></a>    <span class="co">// If we&#39;re not filtering, we just base it on the position</span></span>
<span id="cb8-43"><a href="#cb8-43"></a>    s1 <span class="op">=</span> first<span class="op">;</span></span>
<span id="cb8-44"><a href="#cb8-44"></a>    s2 <span class="op">=</span> first <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb8-45"><a href="#cb8-45"></a>    s3 <span class="op">=</span> first <span class="op">+</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb8-46"><a href="#cb8-46"></a>    s4 <span class="op">=</span> first <span class="op">+</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb8-47"><a href="#cb8-47"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-48"><a href="#cb8-48"></a>    <span class="co">// Otherwise, we use the expand_limited_seed to figure out our seeds, still</span></span>
<span id="cb8-49"><a href="#cb8-49"></a>    <span class="co">// based on position.</span></span>
<span id="cb8-50"><a href="#cb8-50"></a>    <span class="kw">let</span> filter <span class="op">=</span> <span class="va">p_fl</span>.<span class="at">value</span><span class="op">;</span></span>
<span id="cb8-51"><a href="#cb8-51"></a>    s1 <span class="op">=</span> <span class="at">expand_limited_seed</span>(first<span class="op">,</span> filter)<span class="op">;</span></span>
<span id="cb8-52"><a href="#cb8-52"></a>    s2 <span class="op">=</span> <span class="at">expand_limited_seed</span>(first <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> filter)<span class="op">;</span></span>
<span id="cb8-53"><a href="#cb8-53"></a>    s3 <span class="op">=</span> <span class="at">expand_limited_seed</span>(first <span class="op">+</span> <span class="dv">2</span><span class="op">,</span> filter)<span class="op">;</span></span>
<span id="cb8-54"><a href="#cb8-54"></a>    s4 <span class="op">=</span> <span class="at">expand_limited_seed</span>(first <span class="op">+</span> <span class="dv">3</span><span class="op">,</span> filter)<span class="op">;</span></span>
<span id="cb8-55"><a href="#cb8-55"></a>  <span class="op">}</span></span>
<span id="cb8-56"><a href="#cb8-56"></a></span>
<span id="cb8-57"><a href="#cb8-57"></a>  <span class="co">// Now we can generate our non-shuffled poems:</span></span>
<span id="cb8-58"><a href="#cb8-58"></a>  <span class="kw">let</span> p1 <span class="op">=</span> <span class="at">generate_poem</span>(grammar<span class="op">,</span> s1)<span class="op">;</span></span>
<span id="cb8-59"><a href="#cb8-59"></a>  <span class="kw">let</span> p2 <span class="op">=</span> <span class="at">generate_poem</span>(grammar<span class="op">,</span> s2)<span class="op">;</span></span>
<span id="cb8-60"><a href="#cb8-60"></a>  <span class="kw">let</span> p3 <span class="op">=</span> <span class="at">generate_poem</span>(grammar<span class="op">,</span> s3)<span class="op">;</span></span>
<span id="cb8-61"><a href="#cb8-61"></a>  <span class="kw">let</span> p4 <span class="op">=</span> <span class="at">generate_poem</span>(grammar<span class="op">,</span> s4)<span class="op">;</span></span>
<span id="cb8-62"><a href="#cb8-62"></a></span>
<span id="cb8-63"><a href="#cb8-63"></a>  <span class="co">// Here we figure out the seeds for our shuffled poems. Same code as above,</span></span>
<span id="cb8-64"><a href="#cb8-64"></a>  <span class="co">// except we call anarchy.cohort_shuffle on the thing that would have been the</span></span>
<span id="cb8-65"><a href="#cb8-65"></a>  <span class="co">// seed.</span></span>
<span id="cb8-66"><a href="#cb8-66"></a>  <span class="kw">let</span> ss1<span class="op">,</span> ss2<span class="op">,</span> ss3<span class="op">,</span> ss4<span class="op">;</span></span>
<span id="cb8-67"><a href="#cb8-67"></a>  <span class="cf">if</span> (<span class="va">p_fl</span>.<span class="at">value</span> <span class="op">==</span> <span class="st">&quot;none&quot;</span>) <span class="op">{</span></span>
<span id="cb8-68"><a href="#cb8-68"></a>    ss1 <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(first<span class="op">,</span> gr_full<span class="op">,</span> p_seed)<span class="op">;</span></span>
<span id="cb8-69"><a href="#cb8-69"></a>    ss2 <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(first <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> gr_full<span class="op">,</span> p_seed)<span class="op">;</span></span>
<span id="cb8-70"><a href="#cb8-70"></a>    ss3 <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(first <span class="op">+</span> <span class="dv">2</span><span class="op">,</span> gr_full<span class="op">,</span> p_seed)<span class="op">;</span></span>
<span id="cb8-71"><a href="#cb8-71"></a>    ss4 <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(first <span class="op">+</span> <span class="dv">3</span><span class="op">,</span> gr_full<span class="op">,</span> p_seed)<span class="op">;</span></span>
<span id="cb8-72"><a href="#cb8-72"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-73"><a href="#cb8-73"></a>    <span class="co">// Note that in this case, we need to know the size of the smaller</span></span>
<span id="cb8-74"><a href="#cb8-74"></a>    <span class="co">// possibility space, and we apply expand_limited_seed after shuffling. If</span></span>
<span id="cb8-75"><a href="#cb8-75"></a>    <span class="co">// we did it in the other order, we would have expanded seeds (a very</span></span>
<span id="cb8-76"><a href="#cb8-76"></a>    <span class="co">// special subset of all seeds) being shuffled among all seeds, and the</span></span>
<span id="cb8-77"><a href="#cb8-77"></a>    <span class="co">// filter would be broken.</span></span>
<span id="cb8-78"><a href="#cb8-78"></a>    <span class="kw">let</span> filter <span class="op">=</span> <span class="va">p_fl</span>.<span class="at">value</span><span class="op">;</span></span>
<span id="cb8-79"><a href="#cb8-79"></a>    <span class="kw">let</span> base_s1 <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(first<span class="op">,</span> lim_gr_full<span class="op">,</span> p_seed)<span class="op">;</span></span>
<span id="cb8-80"><a href="#cb8-80"></a>    ss1 <span class="op">=</span> <span class="at">expand_limited_seed</span>(base_s1<span class="op">,</span> filter)<span class="op">;</span></span>
<span id="cb8-81"><a href="#cb8-81"></a>    <span class="kw">let</span> base_s2 <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(first <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> lim_gr_full<span class="op">,</span> p_seed)<span class="op">;</span></span>
<span id="cb8-82"><a href="#cb8-82"></a>    ss2 <span class="op">=</span> <span class="at">expand_limited_seed</span>(base_s2<span class="op">,</span> filter)<span class="op">;</span></span>
<span id="cb8-83"><a href="#cb8-83"></a>    <span class="kw">let</span> base_s3 <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(first <span class="op">+</span> <span class="dv">2</span><span class="op">,</span> lim_gr_full<span class="op">,</span> p_seed)<span class="op">;</span></span>
<span id="cb8-84"><a href="#cb8-84"></a>    ss3 <span class="op">=</span> <span class="at">expand_limited_seed</span>(base_s3<span class="op">,</span> filter)<span class="op">;</span></span>
<span id="cb8-85"><a href="#cb8-85"></a>    <span class="kw">let</span> base_s4 <span class="op">=</span> <span class="va">anarchy</span>.<span class="at">cohort_shuffle</span>(first <span class="op">+</span> <span class="dv">3</span><span class="op">,</span> lim_gr_full<span class="op">,</span> p_seed)<span class="op">;</span></span>
<span id="cb8-86"><a href="#cb8-86"></a>    ss4 <span class="op">=</span> <span class="at">expand_limited_seed</span>(base_s4<span class="op">,</span> filter)<span class="op">;</span></span>
<span id="cb8-87"><a href="#cb8-87"></a>  <span class="op">}</span></span>
<span id="cb8-88"><a href="#cb8-88"></a></span>
<span id="cb8-89"><a href="#cb8-89"></a>  <span class="co">// Here we generate the shuffled poems</span></span>
<span id="cb8-90"><a href="#cb8-90"></a>  <span class="kw">let</span> sp1 <span class="op">=</span> <span class="at">generate_poem</span>(grammar<span class="op">,</span> ss1)<span class="op">;</span></span>
<span id="cb8-91"><a href="#cb8-91"></a>  <span class="kw">let</span> sp2 <span class="op">=</span> <span class="at">generate_poem</span>(grammar<span class="op">,</span> ss2)<span class="op">;</span></span>
<span id="cb8-92"><a href="#cb8-92"></a>  <span class="kw">let</span> sp3 <span class="op">=</span> <span class="at">generate_poem</span>(grammar<span class="op">,</span> ss3)<span class="op">;</span></span>
<span id="cb8-93"><a href="#cb8-93"></a>  <span class="kw">let</span> sp4 <span class="op">=</span> <span class="at">generate_poem</span>(grammar<span class="op">,</span> ss4)<span class="op">;</span></span>
<span id="cb8-94"><a href="#cb8-94"></a></span>
<span id="cb8-95"><a href="#cb8-95"></a>  <span class="co">// Here we get rid of the old content of the results div</span></span>
<span id="cb8-96"><a href="#cb8-96"></a>  <span class="va">p_bucket</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb8-97"><a href="#cb8-97"></a></span>
<span id="cb8-98"><a href="#cb8-98"></a>  <span class="co">// Now we create divs for each poem, put in the text, and give them classes</span></span>
<span id="cb8-99"><a href="#cb8-99"></a>  <span class="co">// so that we can assign them to the top or bottom row with CSS (that style</span></span>
<span id="cb8-100"><a href="#cb8-100"></a>  <span class="co">// code isn&#39;t shown, but you can look at the page source to see it; it&#39;s in a</span></span>
<span id="cb8-101"><a href="#cb8-101"></a>  <span class="co">// style block nearby.).</span></span>
<span id="cb8-102"><a href="#cb8-102"></a>  <span class="kw">let</span> d1 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-103"><a href="#cb8-103"></a>  <span class="va">d1</span>.<span class="at">innerHTML</span> <span class="op">=</span> p1<span class="op">;</span></span>
<span id="cb8-104"><a href="#cb8-104"></a>  <span class="va">d1</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&quot;default_poem&quot;</span>)</span>
<span id="cb8-105"><a href="#cb8-105"></a>  <span class="kw">let</span> d2 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-106"><a href="#cb8-106"></a>  <span class="va">d2</span>.<span class="at">innerHTML</span> <span class="op">=</span> p2<span class="op">;</span></span>
<span id="cb8-107"><a href="#cb8-107"></a>  <span class="va">d2</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&quot;default_poem&quot;</span>)</span>
<span id="cb8-108"><a href="#cb8-108"></a>  <span class="kw">let</span> d3 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-109"><a href="#cb8-109"></a>  <span class="va">d3</span>.<span class="at">innerHTML</span> <span class="op">=</span> p3<span class="op">;</span></span>
<span id="cb8-110"><a href="#cb8-110"></a>  <span class="va">d3</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&quot;default_poem&quot;</span>)</span>
<span id="cb8-111"><a href="#cb8-111"></a>  <span class="kw">let</span> d4 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-112"><a href="#cb8-112"></a>  <span class="va">d4</span>.<span class="at">innerHTML</span> <span class="op">=</span> p4<span class="op">;</span></span>
<span id="cb8-113"><a href="#cb8-113"></a>  <span class="va">d4</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&quot;default_poem&quot;</span>)</span>
<span id="cb8-114"><a href="#cb8-114"></a>  <span class="va">p_bucket</span>.<span class="at">appendChild</span>(d1)<span class="op">;</span></span>
<span id="cb8-115"><a href="#cb8-115"></a>  <span class="va">p_bucket</span>.<span class="at">appendChild</span>(d2)<span class="op">;</span></span>
<span id="cb8-116"><a href="#cb8-116"></a>  <span class="va">p_bucket</span>.<span class="at">appendChild</span>(d3)<span class="op">;</span></span>
<span id="cb8-117"><a href="#cb8-117"></a>  <span class="va">p_bucket</span>.<span class="at">appendChild</span>(d4)<span class="op">;</span></span>
<span id="cb8-118"><a href="#cb8-118"></a></span>
<span id="cb8-119"><a href="#cb8-119"></a>  <span class="co">// Here are the divs for the shuffled poems:</span></span>
<span id="cb8-120"><a href="#cb8-120"></a>  <span class="kw">let</span> sd1 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-121"><a href="#cb8-121"></a>  <span class="va">sd1</span>.<span class="at">innerHTML</span> <span class="op">=</span> sp1<span class="op">;</span></span>
<span id="cb8-122"><a href="#cb8-122"></a>  <span class="va">sd1</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&quot;shuffled_poem&quot;</span>)</span>
<span id="cb8-123"><a href="#cb8-123"></a>  <span class="kw">let</span> sd2 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-124"><a href="#cb8-124"></a>  <span class="va">sd2</span>.<span class="at">innerHTML</span> <span class="op">=</span> sp2<span class="op">;</span></span>
<span id="cb8-125"><a href="#cb8-125"></a>  <span class="va">sd2</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&quot;shuffled_poem&quot;</span>)</span>
<span id="cb8-126"><a href="#cb8-126"></a>  <span class="kw">let</span> sd3 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-127"><a href="#cb8-127"></a>  <span class="va">sd3</span>.<span class="at">innerHTML</span> <span class="op">=</span> sp3<span class="op">;</span></span>
<span id="cb8-128"><a href="#cb8-128"></a>  <span class="va">sd3</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&quot;shuffled_poem&quot;</span>)</span>
<span id="cb8-129"><a href="#cb8-129"></a>  <span class="kw">let</span> sd4 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-130"><a href="#cb8-130"></a>  <span class="va">sd4</span>.<span class="at">innerHTML</span> <span class="op">=</span> sp4<span class="op">;</span></span>
<span id="cb8-131"><a href="#cb8-131"></a>  <span class="va">sd4</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&quot;shuffled_poem&quot;</span>)</span>
<span id="cb8-132"><a href="#cb8-132"></a>  <span class="va">p_bucket</span>.<span class="at">appendChild</span>(sd1)<span class="op">;</span></span>
<span id="cb8-133"><a href="#cb8-133"></a>  <span class="va">p_bucket</span>.<span class="at">appendChild</span>(sd2)<span class="op">;</span></span>
<span id="cb8-134"><a href="#cb8-134"></a>  <span class="va">p_bucket</span>.<span class="at">appendChild</span>(sd3)<span class="op">;</span></span>
<span id="cb8-135"><a href="#cb8-135"></a>  <span class="va">p_bucket</span>.<span class="at">appendChild</span>(sd4)<span class="op">;</span></span>
<span id="cb8-136"><a href="#cb8-136"></a></span>
<span id="cb8-137"><a href="#cb8-137"></a></span>
<span id="cb8-138"><a href="#cb8-138"></a>  <span class="co">// These are the labels so that you can see which seed created which poem:</span></span>
<span id="cb8-139"><a href="#cb8-139"></a>  <span class="kw">let</span> l1 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-140"><a href="#cb8-140"></a>  <span class="va">l1</span>.<span class="at">innerText</span> <span class="op">=</span> <span class="st">&#39;#&#39;</span> <span class="op">+</span> s1<span class="op">;</span></span>
<span id="cb8-141"><a href="#cb8-141"></a>  <span class="va">d1</span>.<span class="at">insertBefore</span>(l1<span class="op">,</span> <span class="va">d1</span>.<span class="at">firstChild</span>)<span class="op">;</span></span>
<span id="cb8-142"><a href="#cb8-142"></a>  <span class="kw">let</span> l2 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-143"><a href="#cb8-143"></a>  <span class="va">l2</span>.<span class="at">innerText</span> <span class="op">=</span> <span class="st">&#39;#&#39;</span> <span class="op">+</span> s2<span class="op">;</span></span>
<span id="cb8-144"><a href="#cb8-144"></a>  <span class="va">d2</span>.<span class="at">insertBefore</span>(l2<span class="op">,</span> <span class="va">d2</span>.<span class="at">firstChild</span>)<span class="op">;</span></span>
<span id="cb8-145"><a href="#cb8-145"></a>  <span class="kw">let</span> l3 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-146"><a href="#cb8-146"></a>  <span class="va">l3</span>.<span class="at">innerText</span> <span class="op">=</span> <span class="st">&#39;#&#39;</span> <span class="op">+</span> s3<span class="op">;</span></span>
<span id="cb8-147"><a href="#cb8-147"></a>  <span class="va">d3</span>.<span class="at">insertBefore</span>(l3<span class="op">,</span> <span class="va">d3</span>.<span class="at">firstChild</span>)<span class="op">;</span></span>
<span id="cb8-148"><a href="#cb8-148"></a>  <span class="kw">let</span> l4 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-149"><a href="#cb8-149"></a>  <span class="va">l4</span>.<span class="at">innerText</span> <span class="op">=</span> <span class="st">&#39;#&#39;</span> <span class="op">+</span> s4<span class="op">;</span></span>
<span id="cb8-150"><a href="#cb8-150"></a>  <span class="va">d4</span>.<span class="at">insertBefore</span>(l4<span class="op">,</span> <span class="va">d4</span>.<span class="at">firstChild</span>)<span class="op">;</span></span>
<span id="cb8-151"><a href="#cb8-151"></a></span>
<span id="cb8-152"><a href="#cb8-152"></a>  <span class="co">// These are the labels for the shuffled poems:</span></span>
<span id="cb8-153"><a href="#cb8-153"></a>  <span class="kw">let</span> sl1 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-154"><a href="#cb8-154"></a>  <span class="va">sl1</span>.<span class="at">innerText</span> <span class="op">=</span> <span class="st">&#39;#&#39;</span> <span class="op">+</span> ss1<span class="op">;</span></span>
<span id="cb8-155"><a href="#cb8-155"></a>  <span class="va">sd1</span>.<span class="at">insertBefore</span>(sl1<span class="op">,</span> <span class="va">sd1</span>.<span class="at">firstChild</span>)<span class="op">;</span></span>
<span id="cb8-156"><a href="#cb8-156"></a>  <span class="kw">let</span> sl2 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-157"><a href="#cb8-157"></a>  <span class="va">sl2</span>.<span class="at">innerText</span> <span class="op">=</span> <span class="st">&#39;#&#39;</span> <span class="op">+</span> ss2<span class="op">;</span></span>
<span id="cb8-158"><a href="#cb8-158"></a>  <span class="va">sd2</span>.<span class="at">insertBefore</span>(sl2<span class="op">,</span> <span class="va">sd2</span>.<span class="at">firstChild</span>)<span class="op">;</span></span>
<span id="cb8-159"><a href="#cb8-159"></a>  <span class="kw">let</span> sl3 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-160"><a href="#cb8-160"></a>  <span class="va">sl3</span>.<span class="at">innerText</span> <span class="op">=</span> <span class="st">&#39;#&#39;</span> <span class="op">+</span> ss3<span class="op">;</span></span>
<span id="cb8-161"><a href="#cb8-161"></a>  <span class="va">sd3</span>.<span class="at">insertBefore</span>(sl3<span class="op">,</span> <span class="va">sd3</span>.<span class="at">firstChild</span>)<span class="op">;</span></span>
<span id="cb8-162"><a href="#cb8-162"></a>  <span class="kw">let</span> sl4 <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></span>
<span id="cb8-163"><a href="#cb8-163"></a>  <span class="va">sl4</span>.<span class="at">innerText</span> <span class="op">=</span> <span class="st">&#39;#&#39;</span> <span class="op">+</span> ss4<span class="op">;</span></span>
<span id="cb8-164"><a href="#cb8-164"></a>  <span class="va">sd4</span>.<span class="at">insertBefore</span>(sl4<span class="op">,</span> <span class="va">sd4</span>.<span class="at">firstChild</span>)<span class="op">;</span></span>
<span id="cb8-165"><a href="#cb8-165"></a><span class="op">}</span></span>
<span id="cb8-166"><a href="#cb8-166"></a></span>
<span id="cb8-167"><a href="#cb8-167"></a><span class="co">// Now we call our display function once to initialize things</span></span>
<span id="cb8-168"><a href="#cb8-168"></a><span class="at">display_poems</span>()<span class="op">;</span></span>
<span id="cb8-169"><a href="#cb8-169"></a></span>
<span id="cb8-170"><a href="#cb8-170"></a><span class="co">// These functions respond to the buttons for incrementing/decrementing the</span></span>
<span id="cb8-171"><a href="#cb8-171"></a><span class="co">// location and seed values. They all call display_poems to handle out-of-range</span></span>
<span id="cb8-172"><a href="#cb8-172"></a><span class="co">// values and the like.</span></span>
<span id="cb8-173"><a href="#cb8-173"></a><span class="kw">function</span> <span class="at">p_cycle_prev</span>() <span class="op">{</span></span>
<span id="cb8-174"><a href="#cb8-174"></a>  <span class="va">p_hr</span>.<span class="at">value</span> <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">p_hr</span>.<span class="at">value</span>) <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb8-175"><a href="#cb8-175"></a>  <span class="at">display_poems</span>()<span class="op">;</span></span>
<span id="cb8-176"><a href="#cb8-176"></a><span class="op">}</span></span>
<span id="cb8-177"><a href="#cb8-177"></a></span>
<span id="cb8-178"><a href="#cb8-178"></a><span class="kw">function</span> <span class="at">p_cycle_next</span>() <span class="op">{</span></span>
<span id="cb8-179"><a href="#cb8-179"></a>  <span class="va">p_hr</span>.<span class="at">value</span> <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">p_hr</span>.<span class="at">value</span>) <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb8-180"><a href="#cb8-180"></a>  <span class="at">display_poems</span>()<span class="op">;</span></span>
<span id="cb8-181"><a href="#cb8-181"></a><span class="op">}</span></span>
<span id="cb8-182"><a href="#cb8-182"></a></span>
<span id="cb8-183"><a href="#cb8-183"></a><span class="kw">function</span> <span class="at">p_cycle_pseed</span>() <span class="op">{</span></span>
<span id="cb8-184"><a href="#cb8-184"></a>  <span class="va">p_sd</span>.<span class="at">value</span> <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">p_sd</span>.<span class="at">value</span>) <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb8-185"><a href="#cb8-185"></a>  <span class="at">display_poems</span>()<span class="op">;</span></span>
<span id="cb8-186"><a href="#cb8-186"></a><span class="op">}</span></span>
<span id="cb8-187"><a href="#cb8-187"></a></span>
<span id="cb8-188"><a href="#cb8-188"></a><span class="kw">function</span> <span class="at">p_cycle_nseed</span>() <span class="op">{</span></span>
<span id="cb8-189"><a href="#cb8-189"></a>  <span class="va">p_sd</span>.<span class="at">value</span> <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">p_sd</span>.<span class="at">value</span>) <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb8-190"><a href="#cb8-190"></a>  <span class="at">display_poems</span>()<span class="op">;</span></span>
<span id="cb8-191"><a href="#cb8-191"></a><span class="op">}</span></span>
<span id="cb8-192"><a href="#cb8-192"></a></span>
<span id="cb8-193"><a href="#cb8-193"></a><span class="co">// Finally we just have to wire up our events so that the UI works:</span></span>
<span id="cb8-194"><a href="#cb8-194"></a><span class="va">p_pr</span>.<span class="at">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> p_cycle_prev)<span class="op">;</span></span>
<span id="cb8-195"><a href="#cb8-195"></a><span class="va">p_nx</span>.<span class="at">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> p_cycle_next)<span class="op">;</span></span>
<span id="cb8-196"><a href="#cb8-196"></a><span class="va">p_hr</span>.<span class="at">addEventListener</span>(<span class="st">&quot;blur&quot;</span><span class="op">,</span> display_poems)<span class="op">;</span></span>
<span id="cb8-197"><a href="#cb8-197"></a><span class="va">p_fl</span>.<span class="at">addEventListener</span>(<span class="st">&quot;change&quot;</span><span class="op">,</span> display_poems)<span class="op">;</span></span>
<span id="cb8-198"><a href="#cb8-198"></a><span class="va">p_sd</span>.<span class="at">addEventListener</span>(<span class="st">&quot;blur&quot;</span><span class="op">,</span> display_poems)<span class="op">;</span></span>
<span id="cb8-199"><a href="#cb8-199"></a><span class="va">p_sp</span>.<span class="at">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> p_cycle_pseed)<span class="op">;</span></span>
<span id="cb8-200"><a href="#cb8-200"></a><span class="va">p_sn</span>.<span class="at">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> p_cycle_nseed)<span class="op">;</span></span></code></pre></div>
</details>
<p>Here are the actual results. The top row shows un-shuffled poems, and the bottom row shows shuffled poems from the same space. Note that with traditional shuffling where results are stored in an array, we’d need to store an array of length <code>gr_full</code> (<span class="math inline">2<sup>30</sup></span> = 1073741824, which is about 1 GB, or 4 GB considering each entry would likely need 4 bytes). Additionally, we’d need at least one more array of length <code>lim_gr_full</code> ($2^{28} = 268435456; 1 GB) if we wanted to also handle the filter we’ve implemented, and additional arrays for other filters. Anarchy is happy to give us virtual shuffles without using any space, and only computing the parts that are actually requested, and it can also give us a new shuffle on demand if we just change the seed value, without any extra overhead of re-shuffling things.</p>
<p><input type="button" value="<" id="poetry_demo_previous"> <input type="text" value="0" id="poetry_demo_here"> <input type="button" value=">" id="poetry_demo_next"> filter for: <select id="poetry_demo_filter"> <option value="none" selected>&lt;no filter&gt;</option> <option value="plums">plums</option> <option value="peaches">peaches</option> <option value="apples">apples</option> <option value="larvae">???</option> </select> seed: <input type="text" value="0" id="poetry_demo_seed"> <input type="button" value="-" id="poetry_demo_seed_prev"> <input type="button" value="+" id="poetry_demo_seed_next"></p>
<div id="poetry_demo">

</div>
<style>
#poetry_demo {
  display: grid;
  grid-template-rows: 1fr 1fr;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  grid-row-gap: 24pt;
  grid-column-gap: 12pt;
  font-size: smaller;
  font-family: serif;
}

.default_poem {
  grid-row: 1 / 2;
}

.shuffled_poem {
  grid-row: 2 / 3;
}

.default_poem div, .shuffled_poem div {
  /* The labels */
  margin-bottom: 6pt;
  background: #eee;
  border-radius: 4pt;
  padding: 4pt;
}
</style>
<script type="text/javascript">
let grammar = {
  "root": "{title}<br/><br/>{graf1}<br/>{graf2}<br/>{graf3}",
  "title": [ "This Is Just To Say", "Re: Your Inquiry" ],
  "graf1": [
    "I have {eaten}<br/>the {plums}<br/>that were in<br/>the {container}<br/>",
    "Although you<br/>did not mention<br/>the {plums}<br/>that you had {collected}<br/>"
  ],
  "graf2": [
    "and which<br/>you were probably<br/>{saving}<br/>for {breakfast}<br/>"
  ],
  "graf3": [
    "{forgive} me<br/>they were {delicious}<br/>so {sweet}<br/> and so {cold}",
    "considering your<br/>{outrageous} behavior<br/>I cannot<br/>{regret} my actions"
  ],
  "eaten": [ "eaten", "consumed", "eliminated", "transformed", "crushed" ],
  "plums": [ "plums", "peaches", "apples", "larvae" ], // 6th and 7th bits?
  "container": [ "icebox", "refridgerator", "paper bag", "kitchen", "underworld" ],
  "saving": [ "saving", "hoarding", "eyeing", "considering" ],
  "breakfast": [ "breakfast", "lunch", "dinner", "the ritual" ],
  "forgive": [ "forgive", "pardon", "excuse" ],
  "delicious": [ "delicious", "delectible", "tempting" ],
  "sweet": [ "sweet", "juicy", "purple", "soft" ],
  "cold": [ "cold", "round", "smooth" ],
  "collected": [ "acquired", "collected", "obtained" ],
  "outrageous": [ "outrageous", "past", "current", "uncouth", "magnanimous"],
  "regret": [ "regret", "excuse", "repudiate" ],
}

let gr_combinations = 1*2*2*1*2*5*4*5*4*4*3*3*4*3*3*5*3; // ~ 19 bits
let gr_bits = 0+1+1+0+1+3+2+3+2+2+2+2+2+2+2+3+2; // bits actually used
let gr_full = 1 << gr_bits; // full # of bits used
let lim_gr_bits = gr_bits - 2; // minus the plums choice
let lim_gr_full = 1 << lim_gr_bits; // full # of bits used while limited

// Takes a seed in the range [0, lim_gr_full), which is the right number of
// bits to specify every decision except the 2-bit decision for the grammar key
// "plums", and expands it into the range [0, gr_full) so that it includes the
// bits necessary to specify the given value for the "plums" key. This is
// complicated by the fact that the "plums" decision happens in a different
// place depending on the decision for the expansion of graf1.
function expand_limited_seed(ls, plums_value) {
  let dbits;
  if (plums_value == "plums") {
    dbits = 0;
  } else if (plums_value == "peaches") {
    dbits = 1;
  } else if (plums_value == "apples") {
    dbits = 2;
  } else if (plums_value == "larvae") {
    dbits = 3;
  } else {
    console.warn("Invalid plums_value: '" + plums_value + "'");
    dbits = 0;
  }
  if (ls & (1 << 1)) { // second bit is the graf1 decision
    // In this case the plums decision is the 3rd and 4th bits
    let before = ls & 3;
    let after = ls & ((~3) >>> 0);
    let result = before | (dbits << 2) | (after << 2)
    return result;
  } else {
    // In this case the plums decision is the 6th and 7th bits, because the
    // eaten decision needs 3 bits and comes before the plums decision.
    let mask = ((1 << 5) - 1);
    let before = ls & mask;
    let after = ls & ((~mask) >>> 0);
    let result = before | (dbits << 5) | (after << 2);
    return result;
  }
}

// Generates a poem according to a particular seed
function generate_poem(grammar, seed) {
  // start at the root (which is not a list; just a string)
  let sofar = grammar["root"];
  let bits_used = 0; // track bits used to generate a warning if we need to

  // loop until there aren't any expansions
  while (sofar.indexOf("{") >= 0) {

    // Look for the first expansion (denoted by curly braces) and figure out
    // the before, after, and key:
    let start = sofar.indexOf("{");
    let end = sofar.indexOf("}");
    let before = sofar.substr(0, start);
    let after = sofar.substr(end+1);
    let key = sofar.substr(start+1, end - start - 1);

    if (grammar.hasOwnProperty(key)) {
      // See what our options are and pick one, using up some bits of the seed.
      let options = grammar[key];
      let bits = Math.ceil(Math.log2(options.length));
      let sel = seed % options.length;
      let selected = options[sel];
      seed = seed >> bits; // throw away used-up bits (wastes extra half bits)
      bits_used += bits;
      sofar = before + selected + after; // Reassemble a new working result
    } else {
      // For missing keys, use the key as the value and issue a warning
      sofar = before + key + after;
      console.warn("Missing grammar key: '" + key + "'");
    }
    // Double-check that we haven't used too many bits
    if (bits_used > 32) {
      console.warn("Used more than 32 bits: " + bits_used);
    }
  }
  return sofar;
}
</script>
<script type="text/javascript">
// Get handles for each of our interface elements:
let p_pr = document.getElementById("poetry_demo_previous");
let p_hr = document.getElementById("poetry_demo_here");
let p_nx = document.getElementById("poetry_demo_next");
let p_fl = document.getElementById("poetry_demo_filter");
let p_sd = document.getElementById("poetry_demo_seed");
let p_sp = document.getElementById("poetry_demo_seed_prev");
let p_sn = document.getElementById("poetry_demo_seed_next");

let p_bucket = document.getElementById("poetry_demo");

// This function does the heavy lifting: it looks at interface elements to
// determine the seed and where we are in the space, and overwrites nonsensical
// values, then it calls generate_poem to create the required poems, puts them
// in divs, labels them with their seeds, and uses them to replace the contents
// of the demo div.
function display_poems() {
  // Grab parameters (seed and position) from the UI and overwrite bad values:
  let p_seed = parseInt(p_sd.value) >>> 0;
  if (p_seed == undefined || isNaN(p_seed)) {
    p_seed = 0;
    p_sd.value = p_seed;
  }
  let first = parseInt(p_hr.value);
  if (first == undefined || first <= 0) {
    first = 0;
    p_pr.disabled = true;
  } else {
    p_pr.disabled = false;
  }
  if (first >= gr_combinations - 4) {
    first = gr_combinations - 4;
    p_nx.disabled = true;
  } else {
    p_nx.disabled = false;
  }
  p_hr.value = first;

  // Figure out seeds for our non-shuffled poems:
  let s1, s2, s3, s4;
  if (p_fl.value == "none") {
    // If we're not filtering, we just base it on the position
    s1 = first;
    s2 = first + 1;
    s3 = first + 2;
    s4 = first + 3;
  } else {
    // Otherwise, we use the expand_limited_seed to figure out our seeds, still
    // based on position.
    let filter = p_fl.value;
    s1 = expand_limited_seed(first, filter);
    s2 = expand_limited_seed(first + 1, filter);
    s3 = expand_limited_seed(first + 2, filter);
    s4 = expand_limited_seed(first + 3, filter);
  }

  // Now we can generate our non-shuffled poems:
  let p1 = generate_poem(grammar, s1);
  let p2 = generate_poem(grammar, s2);
  let p3 = generate_poem(grammar, s3);
  let p4 = generate_poem(grammar, s4);

  // Here we figure out the seeds for our shuffled poems. Same code as above,
  // except we call anarchy.cohort_shuffle on the thing that would have been the
  // seed.
  let ss1, ss2, ss3, ss4;
  if (p_fl.value == "none") {
    ss1 = anarchy.cohort_shuffle(first, gr_full, p_seed);
    ss2 = anarchy.cohort_shuffle(first + 1, gr_full, p_seed);
    ss3 = anarchy.cohort_shuffle(first + 2, gr_full, p_seed);
    ss4 = anarchy.cohort_shuffle(first + 3, gr_full, p_seed);
  } else {
    // Note that in this case, we need to know the size of the smaller
    // possibility space, and we apply expand_limited_seed after shuffling. If
    // we did it in the other order, we would have expanded seeds (a very
    // special subset of all seeds) being shuffled among all seeds, and the
    // filter would be broken.
    let filter = p_fl.value;
    let base_s1 = anarchy.cohort_shuffle(first, lim_gr_full, p_seed);
    ss1 = expand_limited_seed(base_s1, filter);
    let base_s2 = anarchy.cohort_shuffle(first + 1, lim_gr_full, p_seed);
    ss2 = expand_limited_seed(base_s2, filter);
    let base_s3 = anarchy.cohort_shuffle(first + 2, lim_gr_full, p_seed);
    ss3 = expand_limited_seed(base_s3, filter);
    let base_s4 = anarchy.cohort_shuffle(first + 3, lim_gr_full, p_seed);
    ss4 = expand_limited_seed(base_s4, filter);
  }

  // Here we generate the shuffled poems
  let sp1 = generate_poem(grammar, ss1);
  let sp2 = generate_poem(grammar, ss2);
  let sp3 = generate_poem(grammar, ss3);
  let sp4 = generate_poem(grammar, ss4);

  // Here we get rid of the old content of the results div
  p_bucket.innerHTML = "";

  // Now we create divs for each poem, put in the text, and give them classes
  // so that we can assign them to the top or bottom row with CSS (that style
  // code isn't shown, but you can look at the page source to see it; it's in a
  // style block nearby.).
  let d1 = document.createElement("div");
  d1.innerHTML = p1;
  d1.classList.add("default_poem")
  let d2 = document.createElement("div");
  d2.innerHTML = p2;
  d2.classList.add("default_poem")
  let d3 = document.createElement("div");
  d3.innerHTML = p3;
  d3.classList.add("default_poem")
  let d4 = document.createElement("div");
  d4.innerHTML = p4;
  d4.classList.add("default_poem")
  p_bucket.appendChild(d1);
  p_bucket.appendChild(d2);
  p_bucket.appendChild(d3);
  p_bucket.appendChild(d4);

  // Here are the divs for the shuffled poems:
  let sd1 = document.createElement("div");
  sd1.innerHTML = sp1;
  sd1.classList.add("shuffled_poem")
  let sd2 = document.createElement("div");
  sd2.innerHTML = sp2;
  sd2.classList.add("shuffled_poem")
  let sd3 = document.createElement("div");
  sd3.innerHTML = sp3;
  sd3.classList.add("shuffled_poem")
  let sd4 = document.createElement("div");
  sd4.innerHTML = sp4;
  sd4.classList.add("shuffled_poem")
  p_bucket.appendChild(sd1);
  p_bucket.appendChild(sd2);
  p_bucket.appendChild(sd3);
  p_bucket.appendChild(sd4);


  // These are the labels so that you can see which seed created which poem:
  let l1 = document.createElement("div");
  l1.innerText = '#' + s1;
  d1.insertBefore(l1, d1.firstChild);
  let l2 = document.createElement("div");
  l2.innerText = '#' + s2;
  d2.insertBefore(l2, d2.firstChild);
  let l3 = document.createElement("div");
  l3.innerText = '#' + s3;
  d3.insertBefore(l3, d3.firstChild);
  let l4 = document.createElement("div");
  l4.innerText = '#' + s4;
  d4.insertBefore(l4, d4.firstChild);

  // These are the labels for the shuffled poems:
  let sl1 = document.createElement("div");
  sl1.innerText = '#' + ss1;
  sd1.insertBefore(sl1, sd1.firstChild);
  let sl2 = document.createElement("div");
  sl2.innerText = '#' + ss2;
  sd2.insertBefore(sl2, sd2.firstChild);
  let sl3 = document.createElement("div");
  sl3.innerText = '#' + ss3;
  sd3.insertBefore(sl3, sd3.firstChild);
  let sl4 = document.createElement("div");
  sl4.innerText = '#' + ss4;
  sd4.insertBefore(sl4, sd4.firstChild);
}

// Now we call our display function once to initialize things
display_poems();

// These functions respond to the buttons for incrementing/decrementing the
// location and seed values. They all call display_poems to handle out-of-range
// values and the like.
function p_cycle_prev() {
  p_hr.value = parseInt(p_hr.value) - 1;
  display_poems();
}

function p_cycle_next() {
  p_hr.value = parseInt(p_hr.value) + 1;
  display_poems();
}

function p_cycle_pseed() {
  p_sd.value = parseInt(p_sd.value) - 1;
  display_poems();
}

function p_cycle_nseed() {
  p_sd.value = parseInt(p_sd.value) + 1;
  display_poems();
}

// Finally we just have to wire up our events so that the UI works:
p_pr.addEventListener("click", p_cycle_prev);
p_nx.addEventListener("click", p_cycle_next);
p_hr.addEventListener("blur", display_poems);
p_fl.addEventListener("change", display_poems);
p_sd.addEventListener("blur", display_poems);
p_sp.addEventListener("click", p_cycle_pseed);
p_sn.addEventListener("click", p_cycle_nseed);
</script>
<h2 id="a-more-complicated-grammar">A More Complicated Grammar</h2>
<p>Potion ingredients:</p>
<div id="complex_grammar_demo">

</div>
<script type=text/javascript>
let grammar2 = {
  "root": "{start}",
  "start": [
    "{ingredient}",
    "{ingredient} and {ingredient}",
    "{ingredient}, {ingredient} and {ingredient}",
  ],
  "ingredient": [
    "{countable-adj-phrase} {countable-noun-phrase}",
    "{uncountable-adj-phrase} {uncountable-noun-phrase}"
  ],
  "countable-noun-phrase": [
    "{animal} {countable-object}",
    "{countable-object} of {animal}",
    "{countable-object}",
    "{animal}",
  ],
  "uncountable-noun-phrase": [
    "{animal} {uncountable-object}",
    "{uncountable-object} of {animal}",
    "{uncountable-object}"
  ],
  "animal": ["cassowary", "okapi", "anole", "bullfrog", "mackerel", "sea-hare"],
  "countable-object": [ "eye", "feather", "foot" ],
  "uncountable-object": [ "skin", "excretion", "blood", "bile" ],
  "countable-adj-phrase": [
    "{size} {color} {state}",
    "{size} {color}",
    "{size} {state}",
  ],
  "uncountable-adj-phrase": [
    "{amount} {state} {color}",
    "{amount} {color}",
    "{amount} {state}",
  ],
  "amount": [ "lots of", "a small amount of", "just a bit of" ],
  "size": [ "a large", "a small", "a pair of" ],
  "color": [ "blue", "yellow", "red", "discolored", "brown", "translucent" ],
  "state": [ "preserved", "fresh", "rotten", "fermented" ],
}

// Generates a concrete expansion of the given grammar, in such a way that
// sequential seeds make similar choices during expansion.
function generate_exact(grammar, seed) {
  // start at the root (which is not a list; just a string)
  let sofar = grammar["root"];
  let rng = seed + 18923712;

  // loop until there aren't any expansions
  while (sofar.indexOf("{") >= 0) {

    // Look for the first expansion (denoted by curly braces) and figure out
    // the before, after, and key:
    let start = sofar.indexOf("{");
    let end = sofar.indexOf("}");
    let before = sofar.substr(0, start);
    let after = sofar.substr(end+1);
    let key = sofar.substr(start+1, end - start - 1);

    if (grammar.hasOwnProperty(key)) {
      // See what our options are and pick one, using up some bits of the seed.
      let options = grammar[key];
      let sel = rng % options.length;
      rng = anarchy.prng(rng, seed);
      let selected = options[sel];
      sofar = before + selected + after; // Reassemble a new working result
    } else {
      // For missing keys, use the key as the value and issue a warning
      sofar = before + key + after;
      console.warn("Missing grammar key: '" + key + "'");
    }
  }
  return sofar;
}

let poem = generate_exact(grammar2, 0);
let cgd = document.getElementById("complex_grammar_demo");
cgd.innerText = poem;
</script>
<h2 id="more-examples">More Examples?</h2>
<p>Have you used this library in an interesting way? Do you have an idea for a cool example? I’d be happy to link to gists or examples to help spread more ideas for using <code>anarchy</code>, or even incorporate more mini-demos here directly. You can open an issue on this repository at <a href="https://github.com/solsword/anarchy/issues">the issues page</a> if you’ve got an idea or demo you’d like me to link to.</p>
</body>
</html>
